<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Flask-SQLAlchemy å¤šè¡¨å¯¹å•æ¨¡å‹ - Leetao</title>
    <meta name="description" content="


# å‰è¨€
åœ¨ Flask ä¸­ Flask-SQLAlchemy åº”è¯¥æ˜¯æœ€å¸¸ç”¨çš„ ORM äº†ï¼Œé€šè¿‡å®ƒæ¥æ„å»º Model  æ¥æ˜ å°„æ•°æ®åº“ä¸­çš„è¡¨ã€‚é€šå¸¸æƒ…å†µä¸‹éƒ½æ˜¯ä¸€ä¸ªè¡...">
    
    <link rel="icon" href="/favicon.svg" type="image/x-icon">
    
    <link rel="stylesheet" href="/styles/main.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/default.min.css">
</head>
<body>
    <header>
        <h1><a href="/">Leetao</a></h1>
        
        <p class="site-description">å†™æœ‰è¶£çš„ä»£ç ï¼Œåšæœ‰è¶£çš„äº‹</p>
        
        <nav>
            <ul>
                <li><a href="/">Home</a></li>
                <li><a href="/tags/">Tags</a></li>
                <li><a href="/about/">About</a></li>
                <li><button class="theme-toggle" id="theme-toggle">
                    <svg class="theme-icon" viewBox="0 0 24 24" width="16" height="16">
                        <path d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"/>
                    </svg>
                    Theme
                </button></li>
            </ul>
        </nav>
    </header>
    
    <main>
        <article class="post">
            <h1>Flask-SQLAlchemy å¤šè¡¨å¯¹å•æ¨¡å‹</h1>
            <p class="meta">
                By LeetaoGoooo on July 16, 2023
            </p>
            
            <div class="content">
                <h1>å‰è¨€</h1>

<p>åœ¨ Flask ä¸­ Flask-SQLAlchemy åº”è¯¥æ˜¯æœ€å¸¸ç”¨çš„ ORM äº†ï¼Œé€šè¿‡å®ƒæ¥æ„å»º Model  æ¥æ˜ å°„æ•°æ®åº“ä¸­çš„è¡¨ã€‚é€šå¸¸æƒ…å†µä¸‹éƒ½æ˜¯ä¸€ä¸ªè¡¨å¯¹åº”ä¸€ä¸ªæ¨¡å‹ï¼Œè¿™ç§æ–¹æ¡ˆå¾ˆç®€å•ã€‚é‚£ä¹ˆå¦‚æœæ˜¯å¤šä¸ªè¡¨å¯¹åº”ä¸€ä¸ªæ¨¡å‹çš„æƒ…å†µä¸‹ï¼Œè¯¥å¦‚ä½•å¤„ç†å‘¢ï¼Ÿæ¥ä¸‹æ¥ç»“åˆä¸€ä¸ªå…·ä½“çš„æ¡ˆä¾‹æ¥è®²è§£è¿™ä¸€å†…å®¹ã€‚</p>

<h1>æ¡ˆä¾‹</h1>

<p>ç°åœ¨æˆ‘æœ‰ä¸€ä¸ªæ•°æ®åº“ <strong>test.db</strong>,å®ƒçš„è¡¨å¦‚ä¸‹ï¼š</p>

<p><img src="http://ww1.sinaimg.cn/large/006wYWbGly1gf74p3v35jj30cc0eg0uy.jpg" alt="1590195419952-4200c916-62c2-4f6e-9c1b-d79859502926.png" /></p>

<p>æœ‰å¾ˆå¤šè¡¨å¹¶ä¸”è¡¨åç±»ä¼¼ï¼Œè€Œä¸”è¡¨åç±»ä¼¼çš„è¡¨çš„ç»“æ„ç›¸åŒï¼Œä»¥ <strong>UPS1_20190716</strong> ä¸ºä¾‹ï¼Œçœ‹ä¸€ä¸‹å®ƒçš„è¡¨ç»“æ„ï¼š</p>

<pre><code class="language-shell">Id
workTime
device
status
temp
</code></pre>

<p>é‚£ä¹ˆå¦‚ä½•å®šä¹‰Modelå‘¢ï¼Ÿåƒä¸‹é¢è¿™æ ·ï¼Ÿ</p>

<pre><code class="language-python">class UPS120190719:
	__tablename__ = 'UPS1_20190716'
	Id = db.Column(db.Integer,primary_key=True)
	workTime = db.Column(db.Time)
	...
    
class UPS220190716:
	__tablename__ = 'UPS2_20190716'
	...
</code></pre>

<p>æ˜¾ç„¶è¿™æ ·å­ä»£ç ä¸å¤Ÿä¼˜é›…ï¼Œæœ‰é‡å¤çš„ä»£ç ï¼Œéœ€è¦ä¼˜åŒ–ã€‚é‚£ä¹ˆè¯¥æ€ä¹ˆè§£å†³å‘¢ï¼Ÿ</p>

<h1>è§£å†³æ–¹æ¡ˆ</h1>

<p>æœ‰ä¿©ç§æ–¹æ¡ˆéƒ½å¯ä»¥è§£å†³ä¸Šè¿°é—®é¢˜ï¼Œä¸è¿‡ä¿©ç§æ–¹æ¡ˆåº”ç”¨åœºæ™¯ç•¥æœ‰ä¸åŒï¼Œå¯ä»¥æ ¹æ®å®é™…æƒ…å†µæ¥å†³å®šã€‚</p>

<h2>ç±»çš„ç»§æ‰¿</h2>

<p>ç¬¬ä¸€ç§æ–¹æ³•å°±æ˜¯åˆ©ç”¨ç±»å¯ä»¥ç»§æ‰¿çš„ç‰¹æ€§å»å®ç°äº†ï¼Œæˆ‘ä»¬å®šä¹‰ä¸€ä¸ªè¡¨çš„åŸºç±»,ç„¶åå…¶å®ƒ UPS è¡¨ç»§æ‰¿ UpsBaseå³å¯ï¼š</p>

<pre><code class="language-python">class UpsBase:
	Id = db.Column(db.Integer,primary_key=True)
   	workTime = db.Column(db.Time)
   	...

class UPS120190716(UpsBase):
	__tablename__ = 'UPS1_20190716'

class UPS220190716(UpsBase):
	__tablename__ = 'UPS2_20190716'
</code></pre>

<p>å½“è¡¨çš„æ•°é‡å›ºå®šè¿™æ˜¯ä¸€ä¸ªå¾ˆå¥½çš„è§£å†³æ–¹æ¡ˆï¼Œä½†æ˜¯ä¸€æ—¦å½“æ•°æ®åº“çš„è¡¨ä¼šå‘ç”Ÿå˜åŠ¨ï¼Œæ¯”å¦‚éš”å¤©å¢é•¿å‡ å¼ è¡¨ï¼Œæ˜¾ç„¶æˆ‘ä»¬ä¸å¤ªå¯èƒ½å¤©å¤©å®šä¹‰æ–°çš„<code>Model</code>ï¼Œç„¶åé‡æ–°éƒ¨ç½²æœåŠ¡çš„ã€‚è¿™ä¸ªæƒ…å†µå°±éœ€è¦ç”¨åˆ°ç¬¬äºŒç§è§£å†³æ–¹æ¡ˆäº†ã€‚</p>

<h2>åŠ¨æ€å®šä¹‰è¡¨ç±»</h2>

<p>åŒæ ·çš„è¿™ç§æ–¹æ³•ä¹Ÿéœ€è¦é¦–å…ˆå®šä¹‰è¡¨çš„åŸºç±»ï¼š</p>

<pre><code class="language-python">class UpsBase:
   Id = db.Column(db.Integer,primary_key=True)
   workTime = db.Column(db.Time)
   ...
</code></pre>

<p>ä½†æ˜¯è¿™é‡Œå°±ä¸éœ€è¦å®šä¹‰å…¶å®ƒ UPS è¡¨çš„ç±»äº†ï¼Œè¿™é‡Œæ˜¯åŠ¨æ€å®šä¹‰ï¼Œé‚£å°±æ„å‘³ç€ï¼Œæˆ‘ä»¬åªåœ¨éœ€è¦çš„æ—¶å€™åˆ›å»ºï¼Œé‚£ä¹ˆå¦‚ä½•åˆ›å»ºå‘¢ï¼Ÿåœ¨ Python ä¸­å¯ä»¥ä½¿ç”¨ type å‡½æ•°åŠ¨æ€åˆ›å»ºç±»ï¼Œéœ€è¦æ³¨æ„çš„æ—¶ï¼Œåœ¨åˆ›å»ºæ—¶éœ€è¦è®¾ç½® **<strong>tablename</strong> **çš„å€¼ã€‚</p>

<pre><code class="language-python">Ups1_20190716 = type('UPS120190716', (UpsBase, db.Model), {'__tablename__':'UPS1_20190716'})
</code></pre>

<p>ä¹‹åå°±å¯ä»¥åˆ›å»ºå®ä¾‹äº†ï¼š</p>

<pre><code class="language-python">Ups = Ups1_20190716()
</code></pre>

<h2>ä¾‹å­</h2>

<p>ä¸‹é¢è¡¥å……ä¸€ä¸ªä¾‹å­ï¼š<strong>å¦‚æœæ ¹æ®è¡¨ååŠ¨æ€åˆ›å»ºè¡¨ï¼Œå¦‚æœè¡¨ä¸å­˜åœ¨åˆ™åˆ›å»º</strong></p>

<pre><code class="language-python3">from flask import Flask,jsonify
from flask_sqlalchemy import SQLAlchemy
from sqlalchemy import inspect


app = Flask(__name__)
app.config[&quot;SQLALCHEMY_DATABASE_URI&quot;] = &quot;sqlite:///test.sqlite3&quot;
app.config[&quot;SQLALCHEMY_TRACK_MODIFICATIONS&quot;] = False

db = SQLAlchemy(app=app)

class UpsBase:
    Id = db.Column(db.Integer,primary_key=True)
    workTime = db.Column(db.Time)

def table_exists(name):
    engine = db.get_engine()
    ret = inspect(engine).has_table(name)
    print('Table &quot;{}&quot; exists: {}'.format(name, ret))
    return ret


@app.route(&quot;/&lt;table_name&gt;&quot;)
def index(table_name):
    if not table_exists(table_name):
        up_test = dynamic_table(UpsBase, table_name)
        up_test.__table__.create(db.engine)
    return jsonify({&quot;code&quot;:200})
    



def dynamic_table(table_base, table_name: str, bind_key='db') -&gt; db.Model:
    &quot;&quot;&quot;[summary]
    Arguments:
        table_base {Object} -- [è¡¨çš„å±æ€§ç±»ï¼ŒåŒ…å«è¡¨çš„æ‰€æœ‰åˆ—]
        table_name {str} -- [è¡¨å]
        bind_key {str} -- [ç»‘å®šçš„æ•°æ®åº“]
    Returns:
        [Model] -- [å¯¹åº”çš„ db Model]
    &quot;&quot;&quot;
    return type(table_name.capitalize(), (table_base, db.Model),
                {'__tablename__': table_name, '__bind_key__': bind_key, '__table_args__': {'extend_existing': True}})()

</code></pre>

            </div>
            
            <div class="tags">
                
            </div>
            
            <div class="giscus">
                <script src="https://giscus.app/client.js"
                    data-repo="leetaogoooo/discussion-blog"
                    data-repo-id="R_kgDOIOm9Yg"
                    data-mapping="number"
                    data-term="49"
                    data-reactions-enabled="1"
                    data-emit-metadata="0"
                    data-input-position="top"
                    data-theme="preferred_color_scheme"
                    data-lang="zh-CN"
                    data-loading="lazy"
                    crossorigin="anonymous"
                    async>
                </script>
            </div>
            
            <div class="back-link">
                <a href="/">&larr; Back to posts</a>
            </div>
        </article>
    </main>
    
    <footer>
        <p>&copy; Leetao. All rights reserved.</p>
    </footer>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js"></script>
    <script src="/js/theme-toggle.js"></script>
    <script>
        
        document.addEventListener('DOMContentLoaded', function() {
            
            const pres = document.querySelectorAll('pre');
            pres.forEach(pre => {
                
                const button = document.createElement('button');
                button.className = 'copy-button';
                button.textContent = 'Copy';
                
                
                pre.appendChild(button);
                
                
                button.addEventListener('click', () => {
                    
                    const code = pre.querySelector('code');
                    const text = code ? code.textContent : pre.textContent;
                    
                    
                    navigator.clipboard.writeText(text).then(() => {
                        
                        button.textContent = 'Copied!';
                        button.classList.add('copied');
                        
                        
                        setTimeout(() => {
                            button.textContent = 'Copy';
                            button.classList.remove('copied');
                        }, 3000);
                    }).catch(err => {
                        console.error('Failed to copy: ', err);
                    });
                });
            });
        });
    </script>
</body>
</html>