<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Flutter WidgetsBindingObserver 详解 - Leetao</title>
    <meta name="description" content="
## 前言

`WidgetsBindingObserver` 是 Flutter 中一个非常重要的接口，它允许你的 Flutter 应用监听和响应底层平台（操作系统）...">
    
    <link rel="icon" href="/favicon.svg" type="image/x-icon">
    
    <link rel="stylesheet" href="/styles/main.css">
    <link rel="stylesheet" href="/styles/chroma.css">
    <link rel="alternate" type="application/rss+xml" href="/rss.xml" title="RSS Feed">
</head>
<body class="container">
    <header class="site-header">
        <div class="site-header__left">
            <a href="/" class="site-title">Leetao</a>
            
            <p class="site-description">写有趣的代码，做有趣的事</p>
            
        </div>
        <div class="site-header__right">
            <nav class="site-nav">
                <a href="/">Home</a>
                <a href="/tags/">Tags</a>
                <a href="/about/">About</a>
                <button class="theme-toggle" id="theme-toggle">
                    <svg class="theme-icon" viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                    </svg>
                </button>
            </nav>
        </div>
    </header>
    
    <main>
        <article class="post">
            <header class="post-header">
                <h1 class="post-title">Flutter WidgetsBindingObserver 详解</h1>
                <p class="post-meta">
                    By LeetaoGoooo on May 21, 2025
                </p>
            </header>
            
            <div class="post-content">
                <h2 id="前言">前言</h2>

<p><code>WidgetsBindingObserver</code> 是 Flutter 中一个非常重要的接口，它允许你的 Flutter 应用监听和响应底层平台（操作系统）和 Flutter 引擎的各种生命周期事件和系统变化。</p>

<h2 id="作用">作用</h2>

<p><code>WidgetsBindingObserver</code> 的核心作用是作为连接 Flutter 应用逻辑和底层系统事件的桥梁。通过实现这个接口，你可以：</p>

<ul>
<li><strong>监听应用生命周期状态变化：</strong> 这是最常用、最重要的功能。你可以知道你的应用何时进入前台、后台，何时被暂停或终止。</li>
<li><strong>监听系统配置变化：</strong> 例如，屏幕尺寸变化、文字缩放因子变化、系统亮度模式（深色/浅色模式）变化、地区设置（语言）变化等。</li>
<li><strong>响应内存压力警告：</strong> 当系统内存不足时，可以通知你的应用采取措施释放资源。</li>
<li><strong>在 Hot Reload 时执行特定操作：</strong> 允许你在开发过程中热重载后执行一些初始化或清理工作。</li>
</ul>

<p>总的来说，它的作用是让你的应用能够<strong>感知并适应外部环境的变化</strong>，从而实现更健壮、更智能的用户体验和资源管理。</p>

<h2 id="使用场景">使用场景</h2>

<h4 id="应用生命周期管理-didchangeapplifecyclestate">应用生命周期管理 (<code>didChangeAppLifecycleState</code>)</h4>

<p>这是最主要、最频繁使用的场景。你需要根据 <code>AppLifecycleState</code> 的不同值来执行相应操作：</p>

<ul>
<li><p><strong><code>AppLifecycleState.resumed</code> (活跃/前台):</strong></p>

<ul>
<li><strong>恢复媒体播放：</strong> 当用户从后台切回应用时，恢复音乐、视频播放。</li>
<li><strong>重新连接网络：</strong> 重新建立 WebSocket 连接或刷新实时数据。</li>
<li><strong>刷新数据：</strong> 例如，刷新聊天列表、社交媒体动态，检查是否有新消息。</li>
<li><strong>启动动画或相机预览：</strong> 只有在前台时才进行耗时操作。</li>
<li><strong>重新认证：</strong> 如果应用长时间处于后台，切回时可能需要重新验证用户身份。</li>
</ul></li>

<li><p><strong><code>AppLifecycleState.inactive</code> (不活跃/暂停 - 仅 iOS 和 Android 部分情况):</strong></p>

<ul>
<li>在 iOS 上，当有电话呼入、短信弹出、应用切换器激活时，应用会进入 <code>inactive</code> 状态。通常在此状态下应<strong>暂停不必要的动画或耗时操作</strong>，但UI通常仍然可见。</li>
<li>在 Android 上，<code>inactive</code> 状态不常用，通常直接从 <code>resumed</code> 跳到 <code>paused</code>。</li>
</ul></li>

<li><p><strong><code>AppLifecycleState.paused</code> (暂停/后台):</strong></p>

<ul>
<li><strong>暂停媒体播放：</strong> 当用户切换到其他应用时，停止音乐、视频播放。</li>
<li><strong>断开网络连接：</strong> 断开实时连接（如游戏、聊天），减少耗电。</li>
<li><strong>保存用户数据：</strong> 在应用进入后台前保存草稿、进度、用户设置等，防止数据丢失。</li>
<li><strong>停止相机预览：</strong> 关闭相机硬件，释放资源。</li>
<li><strong>清理敏感数据：</strong> 将密码、银行卡号等敏感信息从内存中清除。</li>
</ul></li>

<li><p><strong><code>AppLifecycleState.detached</code> (分离/终止 - 仅 Android):</strong></p>

<ul>
<li>仅在 Android 上出现，表示应用进程可能仍在运行，但 Flutter 引擎的视图已被移除。通常在 Flutter Activity 被销毁但进程未被杀死时发生。</li>
<li>可以进行最后的资源清理工作，但通常在 <code>paused</code> 状态下完成大部分清理。</li>
</ul></li>
</ul>

<h4 id="系统配置变化-didchange">系统配置变化 (<code>didChange...</code>)</h4>

<ul>
<li><p><strong><code>didChangePlatformBrightness</code> (深色/浅色模式切换):</strong></p>

<ul>
<li><strong>更新主题或UI：</strong> 如果你的应用有自定义的 UI 元素，而不仅仅依赖 <code>ThemeData</code>，你可能需要手动更新它们的颜色或样式以适应新的亮度模式。</li>
<li><strong>切换图片资源：</strong> 根据亮暗模式加载不同的图片或图标。</li>
</ul></li>

<li><p><strong><code>didChangeLocales</code> (系统语言/地区设置变化):</strong></p>

<ul>
<li><strong>重新加载本地化资源：</strong> 如果你的应用使用了自定义的国际化方案，或者需要根据语言加载不同的动态内容，可以在这里触发重新加载。</li>
<li><strong>更新日期/时间格式：</strong> 根据新的地区设置调整显示格式。</li>
</ul></li>

<li><p><strong><code>didChangeTextScaleFactor</code> (文字缩放因子变化):</strong></p>

<ul>
<li><strong>调整自定义文本布局：</strong> 如果你的应用中有非常复杂的文本布局，可能需要根据用户设置的文字大小偏好进行微调。通常 Flutter 默认的 <code>MediaQuery</code> 会处理大部分情况。</li>
</ul></li>

<li><p><strong><code>didChangeMetrics</code> (屏幕尺寸/像素比变化):</strong></p>

<ul>
<li><strong>响应屏幕旋转或分屏模式：</strong> 某些情况下，你可能需要根据新的屏幕尺寸重新绘制或调整布局，尤其是在使用自定义渲染或 Canvas 绘图时。</li>
</ul></li>
</ul>

<h4 id="内存管理-didhavememorypressure">内存管理 (<code>didHaveMemoryPressure</code>)</h4>

<ul>
<li><strong>清理缓存：</strong> 当系统发出内存压力警告时，主动清除图片缓存、网络请求缓存或其他不必要的内存占用，以防止应用被系统强制关闭。</li>
<li><strong>释放非关键资源：</strong> 释放一些可以随时重新加载的、但当前不急需的大型对象。</li>
</ul>

<h2 id="用法">用法</h2>

<p>使用 <code>WidgetsBindingObserver</code> 的典型做法就是将其混入到一个 <code>StatefulWidget</code> 的 <code>State</code> 类中：</p>

<ol>
<li><p><strong>混入 <code>WidgetsBindingObserver</code>：</strong>
在 <code>State</code> 类定义上使用 <code>with WidgetsBindingObserver</code>。</p></li>

<li><p><strong>注册观察者：</strong>
在 <code>initState()</code> 方法中，调用 <code>WidgetsBinding.instance.addObserver(this)</code> 将当前 <code>State</code> 对象注册为观察者。</p></li>

<li><p><strong>实现回调方法：</strong>
覆盖对应的回调方法（如 <code>didChangeAppLifecycleState</code>）。</p></li>

<li><p><strong>移除观察者：</strong>
在 <code>dispose()</code> 方法中，务必调用 <code>WidgetsBinding.instance.removeObserver(this)</code> 来移除观察者，防止内存泄漏。</p></li>
</ol>

<p><strong>示例代码：</strong></p>
<pre class="chroma"><code><span class="line"><span class="cl"><span class="k">import</span> <span class="s1">&#39;</span><span class="s1">package:flutter/material.dart</span><span class="s1">&#39;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">class</span> <span class="nc">LifecycleAwareWidget</span> <span class="kd">extends</span> <span class="n">StatefulWidget</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="err">@</span><span class="n">override</span>
</span></span><span class="line"><span class="cl">  <span class="n">_LifecycleAwareWidgetState</span> <span class="n">createState</span><span class="p">(</span><span class="p">)</span> <span class="o">=</span><span class="o">&gt;</span> <span class="n">_LifecycleAwareWidgetState</span><span class="p">(</span><span class="p">)</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">class</span> <span class="nc">_LifecycleAwareWidgetState</span> <span class="kd">extends</span> <span class="n">State</span><span class="o">&lt;</span><span class="n">LifecycleAwareWidget</span><span class="o">&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="kd">with</span> <span class="n">WidgetsBindingObserver</span> <span class="p">{</span> <span class="c1">// 1. 混入 WidgetsBindingObserver
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">  <span class="err">@</span><span class="n">override</span>
</span></span><span class="line"><span class="cl">  <span class="kt">void</span> <span class="n">initState</span><span class="p">(</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">super</span><span class="p">.</span><span class="n">initState</span><span class="p">(</span><span class="p">)</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">WidgetsBinding</span><span class="p">.</span><span class="n">instance</span><span class="p">.</span><span class="n">addObserver</span><span class="p">(</span><span class="k">this</span><span class="p">)</span><span class="p">;</span> <span class="c1">// 2. 注册观察者
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="s1">Widget initState - Observer added</span><span class="s1">&#39;</span><span class="p">)</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="err">@</span><span class="n">override</span>
</span></span><span class="line"><span class="cl">  <span class="kt">void</span> <span class="n">dispose</span><span class="p">(</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">WidgetsBinding</span><span class="p">.</span><span class="n">instance</span><span class="p">.</span><span class="n">removeObserver</span><span class="p">(</span><span class="k">this</span><span class="p">)</span><span class="p">;</span> <span class="c1">// 4. 移除观察者，防止内存泄漏
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="s1">Widget dispose - Observer removed</span><span class="s1">&#39;</span><span class="p">)</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">super</span><span class="p">.</span><span class="n">dispose</span><span class="p">(</span><span class="p">)</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="c1">// 3. 实现回调方法
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="err">@</span><span class="n">override</span>
</span></span><span class="line"><span class="cl">  <span class="kt">void</span> <span class="n">didChangeAppLifecycleState</span><span class="p">(</span><span class="n">AppLifecycleState</span> <span class="n">state</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="s1">AppLifecycleState changed: </span><span class="si">$</span><span class="n">state</span><span class="s1">&#39;</span><span class="p">)</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">switch</span> <span class="p">(</span><span class="n">state</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="k">case</span> <span class="n">AppLifecycleState</span><span class="p">.</span><span class="nl">resumed:</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// 应用回到前台
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="s1">App is back in foreground!</span><span class="s1">&#39;</span><span class="p">)</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// 示例：重新加载数据，恢复动画，重新连接Socket等
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="k">case</span> <span class="n">AppLifecycleState</span><span class="p">.</span><span class="nl">inactive:</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// 应用处于不活跃状态（如iOS来电、多任务切换器）
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="s1">App is inactive.</span><span class="s1">&#39;</span><span class="p">)</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// 示例：暂停非关键的动画
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="k">case</span> <span class="n">AppLifecycleState</span><span class="p">.</span><span class="nl">paused:</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// 应用进入后台
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="s1">App is in background.</span><span class="s1">&#39;</span><span class="p">)</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// 示例：保存数据，暂停媒体播放，断开Socket，停止相机等
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="k">case</span> <span class="n">AppLifecycleState</span><span class="p">.</span><span class="nl">detached:</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// 应用被分离（Android，Flutter引擎视图被移除）
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="s1">App is detached.</span><span class="s1">&#39;</span><span class="p">)</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// 示例：执行最后的清理
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="k">case</span> <span class="n">AppLifecycleState</span><span class="p">.</span><span class="nl">hidden:</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// 应用被隐藏 (Web 或特定场景，不常用)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="s1">App is hidden.</span><span class="s1">&#39;</span><span class="p">)</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="err">@</span><span class="n">override</span>
</span></span><span class="line"><span class="cl">  <span class="kt">void</span> <span class="n">didChangeMetrics</span><span class="p">(</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="s1">Metrics changed (e.g., screen size, orientation)</span><span class="s1">&#39;</span><span class="p">)</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// 示例：响应屏幕旋转
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="err">@</span><span class="n">override</span>
</span></span><span class="line"><span class="cl">  <span class="kt">void</span> <span class="n">didChangePlatformBrightness</span><span class="p">(</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="s1">Platform brightness changed (dark/light mode)</span><span class="s1">&#39;</span><span class="p">)</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// 示例：更新自定义UI的主题
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="err">@</span><span class="n">override</span>
</span></span><span class="line"><span class="cl">  <span class="kt">void</span> <span class="n">didChangeLocales</span><span class="p">(</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="s1">Locales changed (language settings)</span><span class="s1">&#39;</span><span class="p">)</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// 示例：重新加载国际化资源
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="err">@</span><span class="n">override</span>
</span></span><span class="line"><span class="cl">  <span class="kt">void</span> <span class="n">didHaveMemoryPressure</span><span class="p">(</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="s1">Received memory pressure warning!</span><span class="s1">&#39;</span><span class="p">)</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// 示例：清理缓存
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="c1">// 其他回调方法...
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">  <span class="err">@</span><span class="n">override</span>
</span></span><span class="line"><span class="cl">  <span class="n">Widget</span> <span class="n">build</span><span class="p">(</span><span class="n">BuildContext</span> <span class="n">context</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">Scaffold</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">      <span class="nl">appBar:</span> <span class="n">AppBar</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">        <span class="nl">title:</span> <span class="n">Text</span><span class="p">(</span><span class="s1">&#39;</span><span class="s1">WidgetsBindingObserver Demo</span><span class="s1">&#39;</span><span class="p">)</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="p">)</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="nl">body:</span> <span class="n">Center</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">        <span class="nl">child:</span> <span class="n">Text</span><span class="p">(</span><span class="s1">&#39;</span><span class="s1">Check console for lifecycle and system events!</span><span class="s1">&#39;</span><span class="p">)</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="p">)</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="p">)</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="n">main</span><span class="p">(</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="n">runApp</span><span class="p">(</span><span class="n">MaterialApp</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">    <span class="nl">home:</span> <span class="n">LifecycleAwareWidget</span><span class="p">(</span><span class="p">)</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="p">)</span><span class="p">)</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre>
<h3 id="注意事项">注意事项：</h3>

<ul>
<li><strong>不阻塞UI：</strong> 在回调方法中不要执行耗时的操作，否则的话，会阻塞主线程，影响用户体验。耗时操作应当其放到后台线程中去执行。</li>
<li><strong>处理平台差异：</strong> <code>AppLifecycleState</code> 的某些状态在不同平台上的行为可能略有不同（例如 <code>inactive</code> 主要用于 iOS）。在编写逻辑时需要考虑这些差异。</li>
</ul>

<h1 id="v-s-applifecyclelistener">V.S.  AppLifecycleListener</h1>

<p>如果仅需要检测生命周期的变化的话，建议选择 <code>AppLifecycleListener</code>,因为相较于 <code>WidgetsBindingObserver</code>,后者提供了更细粒度的、独立的生命周期回调方法。</p>

<p>AppLifecycleListener 是 Flutter 3.10 引入的<strong>新 API</strong>，专门用于<strong>更清晰、更现代地管理应用生命周期</strong>。专门用来解决 didChangeAppLifecycleState 中某些状态的歧义，并提供更符合现代操作系统（尤其是桌面和 Web）行为的生命周期管理。</p>

<p><img src="https://github.com/user-attachments/assets/2f104c94-c309-4041-b63f-092badf81bfe" alt="Diagram of the application lifecycle defined by the AppLifecycleState enum" /></p>

<h3 id="示例">示例</h3>
<pre class="chroma"><code><span class="line"><span class="cl"><span class="k">import</span> <span class="s1">&#39;</span><span class="s1">package:flutter/material.dart</span><span class="s1">&#39;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">import</span> <span class="s1">&#39;</span><span class="s1">package:flutter/scheduler.dart</span><span class="s1">&#39;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="n">main</span><span class="p">(</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="n">runApp</span><span class="p">(</span><span class="kd">const</span> <span class="n">AppLifecycleListenerExample</span><span class="p">(</span><span class="p">)</span><span class="p">)</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">class</span> <span class="nc">AppLifecycleListenerExample</span> <span class="kd">extends</span> <span class="n">StatelessWidget</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="kd">const</span> <span class="n">AppLifecycleListenerExample</span><span class="p">(</span><span class="p">{</span><span class="k">super</span><span class="p">.</span><span class="n">key</span><span class="p">}</span><span class="p">)</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="err">@</span><span class="n">override</span>
</span></span><span class="line"><span class="cl">  <span class="n">Widget</span> <span class="n">build</span><span class="p">(</span><span class="n">BuildContext</span> <span class="n">context</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="kd">const</span> <span class="n">MaterialApp</span><span class="p">(</span><span class="nl">home:</span> <span class="n">Scaffold</span><span class="p">(</span><span class="nl">body:</span> <span class="n">AppLifecycleDisplay</span><span class="p">(</span><span class="p">)</span><span class="p">)</span><span class="p">)</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">class</span> <span class="nc">AppLifecycleDisplay</span> <span class="kd">extends</span> <span class="n">StatefulWidget</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="kd">const</span> <span class="n">AppLifecycleDisplay</span><span class="p">(</span><span class="p">{</span><span class="k">super</span><span class="p">.</span><span class="n">key</span><span class="p">}</span><span class="p">)</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="err">@</span><span class="n">override</span>
</span></span><span class="line"><span class="cl">  <span class="n">State</span><span class="o">&lt;</span><span class="n">AppLifecycleDisplay</span><span class="o">&gt;</span> <span class="n">createState</span><span class="p">(</span><span class="p">)</span> <span class="o">=</span><span class="o">&gt;</span> <span class="n">_AppLifecycleDisplayState</span><span class="p">(</span><span class="p">)</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">class</span> <span class="nc">_AppLifecycleDisplayState</span> <span class="kd">extends</span> <span class="n">State</span><span class="o">&lt;</span><span class="n">AppLifecycleDisplay</span><span class="o">&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="n">late</span> <span class="kd">final</span> <span class="n">AppLifecycleListener</span> <span class="n">_listener</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="kd">final</span> <span class="n">ScrollController</span> <span class="n">_scrollController</span> <span class="o">=</span> <span class="n">ScrollController</span><span class="p">(</span><span class="p">)</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="kd">final</span> <span class="n">List</span><span class="o">&lt;</span><span class="kt">String</span><span class="o">&gt;</span> <span class="n">_states</span> <span class="o">=</span> <span class="o">&lt;</span><span class="kt">String</span><span class="o">&gt;</span><span class="p">[</span><span class="p">]</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">late</span> <span class="n">AppLifecycleState</span><span class="o">?</span> <span class="n">_state</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="err">@</span><span class="n">override</span>
</span></span><span class="line"><span class="cl">  <span class="kt">void</span> <span class="n">initState</span><span class="p">(</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">super</span><span class="p">.</span><span class="n">initState</span><span class="p">(</span><span class="p">)</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">_state</span> <span class="o">=</span> <span class="n">SchedulerBinding</span><span class="p">.</span><span class="n">instance</span><span class="p">.</span><span class="n">lifecycleState</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">_listener</span> <span class="o">=</span> <span class="n">AppLifecycleListener</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">      <span class="nl">onShow:</span> <span class="p">(</span><span class="p">)</span> <span class="o">=</span><span class="o">&gt;</span> <span class="n">_handleTransition</span><span class="p">(</span><span class="s1">&#39;</span><span class="s1">show</span><span class="s1">&#39;</span><span class="p">)</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="nl">onResume:</span> <span class="p">(</span><span class="p">)</span> <span class="o">=</span><span class="o">&gt;</span> <span class="n">_handleTransition</span><span class="p">(</span><span class="s1">&#39;</span><span class="s1">resume</span><span class="s1">&#39;</span><span class="p">)</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="nl">onHide:</span> <span class="p">(</span><span class="p">)</span> <span class="o">=</span><span class="o">&gt;</span> <span class="n">_handleTransition</span><span class="p">(</span><span class="s1">&#39;</span><span class="s1">hide</span><span class="s1">&#39;</span><span class="p">)</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="nl">onInactive:</span> <span class="p">(</span><span class="p">)</span> <span class="o">=</span><span class="o">&gt;</span> <span class="n">_handleTransition</span><span class="p">(</span><span class="s1">&#39;</span><span class="s1">inactive</span><span class="s1">&#39;</span><span class="p">)</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="nl">onPause:</span> <span class="p">(</span><span class="p">)</span> <span class="o">=</span><span class="o">&gt;</span> <span class="n">_handleTransition</span><span class="p">(</span><span class="s1">&#39;</span><span class="s1">pause</span><span class="s1">&#39;</span><span class="p">)</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="nl">onDetach:</span> <span class="p">(</span><span class="p">)</span> <span class="o">=</span><span class="o">&gt;</span> <span class="n">_handleTransition</span><span class="p">(</span><span class="s1">&#39;</span><span class="s1">detach</span><span class="s1">&#39;</span><span class="p">)</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="nl">onRestart:</span> <span class="p">(</span><span class="p">)</span> <span class="o">=</span><span class="o">&gt;</span> <span class="n">_handleTransition</span><span class="p">(</span><span class="s1">&#39;</span><span class="s1">restart</span><span class="s1">&#39;</span><span class="p">)</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="nl">onStateChange:</span> <span class="n">_handleStateChange</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="p">)</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">_state</span> <span class="o">!</span><span class="o">=</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="n">_states</span><span class="p">.</span><span class="n">add</span><span class="p">(</span><span class="n">_state</span><span class="o">!</span><span class="p">.</span><span class="n">name</span><span class="p">)</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="err">@</span><span class="n">override</span>
</span></span><span class="line"><span class="cl">  <span class="kt">void</span> <span class="n">dispose</span><span class="p">(</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">_listener</span><span class="p">.</span><span class="n">dispose</span><span class="p">(</span><span class="p">)</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">super</span><span class="p">.</span><span class="n">dispose</span><span class="p">(</span><span class="p">)</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="kt">void</span> <span class="n">_handleTransition</span><span class="p">(</span><span class="kt">String</span> <span class="n">name</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">setState</span><span class="p">(</span><span class="p">(</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="n">_states</span><span class="p">.</span><span class="n">add</span><span class="p">(</span><span class="n">name</span><span class="p">)</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span><span class="p">)</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">_scrollController</span><span class="p">.</span><span class="n">animateTo</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">      <span class="n">_scrollController</span><span class="p">.</span><span class="n">position</span><span class="p">.</span><span class="n">maxScrollExtent</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="nl">duration:</span> <span class="kd">const</span> <span class="n">Duration</span><span class="p">(</span><span class="nl">milliseconds:</span> <span class="m">200</span><span class="p">)</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="nl">curve:</span> <span class="n">Curves</span><span class="p">.</span><span class="n">easeOut</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="p">)</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="kt">void</span> <span class="n">_handleStateChange</span><span class="p">(</span><span class="n">AppLifecycleState</span> <span class="n">state</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">setState</span><span class="p">(</span><span class="p">(</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="n">_state</span> <span class="o">=</span> <span class="n">state</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span><span class="p">)</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="err">@</span><span class="n">override</span>
</span></span><span class="line"><span class="cl">  <span class="n">Widget</span> <span class="n">build</span><span class="p">(</span><span class="n">BuildContext</span> <span class="n">context</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">Center</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">      <span class="nl">child:</span> <span class="n">SizedBox</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">        <span class="nl">width:</span> <span class="m">300</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nl">child:</span> <span class="n">SingleChildScrollView</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">          <span class="nl">controller:</span> <span class="n">_scrollController</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">          <span class="nl">child:</span> <span class="n">Column</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">            <span class="nl">children:</span> <span class="o">&lt;</span><span class="n">Widget</span><span class="o">&gt;</span><span class="p">[</span>
</span></span><span class="line"><span class="cl">              <span class="n">Text</span><span class="p">(</span><span class="s1">&#39;</span><span class="s1">Current State: </span><span class="si">${</span><span class="n">_state</span> <span class="o">?</span><span class="o">?</span> <span class="s1">&#39;</span><span class="s1">Not initialized yet</span><span class="s1">&#39;</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">              <span class="kd">const</span> <span class="n">SizedBox</span><span class="p">(</span><span class="nl">height:</span> <span class="m">30</span><span class="p">)</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">              <span class="n">Text</span><span class="p">(</span><span class="s1">&#39;</span><span class="s1">State History:</span><span class="se">\n</span><span class="s1">  </span><span class="si">${</span><span class="n">_states</span><span class="p">.</span><span class="n">join</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">  </span><span class="s1">&#39;</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="p">]</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">          <span class="p">)</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="p">)</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="p">)</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="p">)</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre>
<h2 id="参考文档">参考文档</h2>

<ol>
<li><a href="https://api.flutter.dev/flutter/widgets/AppLifecycleListener-class.html">AppLifecycleListener</a></li>
<li><a href="https://api.flutter.dev/flutter/dart-ui/AppLifecycleState.html">AppLifecycleState</a></li>
<li><a href="https://api.flutter.dev/flutter/widgets/WidgetsBindingObserver-class.html">WidgetsBindingObserver</a></li>
</ol>

            </div>
            
            <div class="tag-list">
                
                <a href="/tags/flutter/" class="tag">flutter</a>
                
            </div>
            
            <div class="giscus">
                <script src="https://giscus.app/client.js"
                    data-repo="leetaogoooo/discussion-blog"
                    data-repo-id="R_kgDOIOm9Yg"
                    data-mapping="number"
                    data-term="264"
                    data-reactions-enabled="1"
                    data-emit-metadata="0"
                    data-input-position="top"
                    data-theme="light"
                    data-lang="en"
                    crossorigin="anonymous"
                    async>
                </script>
            </div>
            
        </article>
    </main>
    
    <footer>
        <p>&copy; Leetao. All rights reserved.</p>
    </footer>
    
    <script src="/js/theme-toggle.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            
            const giscusScript = document.querySelector('script[src^="https://giscus.app/client.js"]');
            const setGiscusTheme = (theme) => {
                if (giscusScript) {
                    const message = { setConfig: { theme: theme } };
                    const iframe = document.querySelector('.giscus-frame');
                    if (iframe) {
                        iframe.contentWindow.postMessage({ giscus: message }, 'https://giscus.app');
                    }
                }
            };
            const currentTheme = document.documentElement.getAttribute('data-theme') || 'light';
            setGiscusTheme(currentTheme);
            new MutationObserver((mutations) => {
                mutations.forEach(mutation => {
                    if (mutation.attributeName === 'data-theme') {
                        setGiscusTheme(mutation.target.getAttribute('data-theme'));
                    }
                });
            }).observe(document.documentElement, { attributes: true });


            
            function initCopyButtons() {
                document.querySelectorAll('pre.chroma').forEach((pre) => {
                    
                    const existingButton = pre.querySelector('.copy-button');
                    if (existingButton) {
                        existingButton.remove();
                    }
                    
                    const button = document.createElement('button');
                    button.className = 'copy-button';
                    button.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path></svg>';
                    
                    pre.style.position = 'relative';
                    pre.appendChild(button);
                    
                    button.addEventListener('click', () => {
                        const code = pre.querySelector('code');
                        if (code) {
                            navigator.clipboard.writeText(code.innerText).then(() => {
                                button.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M20 6L9 17l-5-5"></path></svg>';
                                setTimeout(() => {
                                    button.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path></svg>';
                                }, 2000);
                            });
                        }
                    });
                });
                const button = document.createElement('button');
                button.className = 'copy-button';
                button.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path></svg>';
                
                pre.style.position = 'relative';
                pre.appendChild(button);
                
                button.addEventListener('click', () => {
                    const code = pre.querySelector('code');
                    if (code) {
                        navigator.clipboard.writeText(code.innerText).then(() => {
                            button.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M20 6L9 17l-5-5"></path></svg>';
                            setTimeout(() => {
                                button.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path></svg>';
                            }, 2000);
                        });
                    }
                });
            }
            
            
            initCopyButtons();
            
            
            document.addEventListener('themeChanged', () => {
                initCopyButtons();
            });
        });
    </script>
</body>
</html>