<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>A Discord bot sent an image with Chinese characters, which caused garbled text issues - Leetao</title>
    <meta name="description" content="# TL;DR

**How to make Chinese characters display properly on Chromium. All of these issues due to font weren&#39;t installed.** 


# Intro

![garbled text i...">
    
    <link rel="icon" href="/favicon.svg" type="image/x-icon">
    
    <link rel="stylesheet" href="/styles/main.css">
    <link rel="stylesheet" href="/styles/chroma.css">
    <link rel="alternate" type="application/rss+xml" href="/rss.xml" title="RSS Feed">
</head>
<body class="container">
    <header class="site-header">
        <div class="site-header__left">
            <a href="/" class="site-title">Leetao</a>
            
            <p class="site-description">写有趣的代码，做有趣的事</p>
            
        </div>
        <div class="site-header__right">
            <nav class="site-nav">
                <a href="/">Home</a>
                <a href="/tags/">Tags</a>
                <a href="/about/">About</a>
                <button class="theme-toggle" id="theme-toggle">
                    <svg class="theme-icon" viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                    </svg>
                </button>
            </nav>
        </div>
    </header>
    
    <main>
        <article class="post">
            <header class="post-header">
                <h1 class="post-title">A Discord bot sent an image with Chinese characters, which caused garbled text issues</h1>
                <p class="post-meta">
                    By LeetaoGoooo on October 2, 2024
                </p>
            </header>
            
            <div class="post-content">
                <h1 id="tl-dr">TL;DR</h1>

<p><strong>How to make Chinese characters display properly on Chromium. All of these issues due to font weren't installed.</strong></p>

<h1 id="intro">Intro</h1>

<p><img src="https://github.com/user-attachments/assets/6772be56-76c6-44a2-aa93-54c2b9bdd56f" alt="garbled text issues" /></p>

<p>These two days i've been working on a <a href="https://github.com/LeetaoGoooo/discord-robots">discord-robots</a> project and implemented a new feature - generating excerpt card.</p>

<p><img width="628" alt="image" src="https://github.com/user-attachments/assets/3cb9fa18-8aea-4606-847e-bb94f26501c2"></p>

<p>You just need to input instructions according to the requirements and then the robot will generate beautiful card for you.</p>

<p><img src="https://github.com/user-attachments/assets/048956b9-b876-43e6-afbd-a25f5c16a379" alt="generate card" /></p>

<p>Everything works fine until I try to generate a card with Chinese characters. The result shows up at the beginning of the post.</p>

<h1 id="debugging">Debugging</h1>

<p><img src="https://github.com/user-attachments/assets/999d409e-e0fb-4863-87f2-f06be4fd7303" alt="process of excerpt card" /></p>

<p>The whole process just likes image above. I started debugging the issue and suspected that Jinja was rendering the HTML with an encoding error firstly. So I dumped the rendered string to a file. After reviewing the HTML string, it seems that the characters aren't garbled.</p>

<p>So there must be  something wrong with html-to-image service or sending image to discord.</p>
<pre class="chroma"><code><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">html2img_with_selector</span><span class="p">(</span><span class="n">html_str</span><span class="p">:</span><span class="nb">str</span><span class="p">,</span> <span class="n">id_selector</span><span class="p">:</span><span class="nb">str</span><span class="p">)</span> <span class="o">-</span><span class="o">&gt;</span> <span class="n">Path</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="n">chrome_options</span> <span class="o">=</span> <span class="n">webdriver</span><span class="o">.</span><span class="n">FirefoxOptions</span><span class="p">(</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="o">.</span><span class="o">.</span><span class="o">.</span>
</span></span><span class="line"><span class="cl">    <span class="n">driver</span> <span class="o">=</span> <span class="n">webdriver</span><span class="o">.</span><span class="n">Firefox</span><span class="p">(</span><span class="n">service</span><span class="o">=</span><span class="n">service</span><span class="p">,</span> <span class="n">options</span><span class="o">=</span><span class="n">chrome_options</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">screen_shoot_path</span> <span class="o">=</span> <span class="n">work_dir</span><span class="o">.</span><span class="n">joinpath</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">file_name</span><span class="si">}</span><span class="s1">.png</span><span class="s1">&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">try</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="o">.</span><span class="o">.</span><span class="o">.</span>
</span></span><span class="line"><span class="cl">        <span class="n">driver</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;</span><span class="s2">file://</span><span class="si">{</span><span class="n">file_path</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="o">.</span><span class="o">.</span><span class="o">.</span>
</span></span><span class="line"><span class="cl">        <span class="n">element</span> <span class="o">=</span> <span class="n">driver</span><span class="o">.</span><span class="n">find_element</span><span class="p">(</span><span class="n">By</span><span class="o">.</span><span class="n">ID</span><span class="p">,</span> <span class="n">id_selector</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">element</span><span class="o">.</span><span class="n">screenshot</span><span class="p">(</span><span class="n">screen_shoot_path</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="o">.</span><span class="o">.</span><span class="o">.</span>
</span></span><span class="line"><span class="cl">    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;</span><span class="s2">Screenshot failed: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span>
</span></span><span class="line"><span class="cl">    <span class="k">finally</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">driver</span><span class="o">.</span><span class="n">quit</span><span class="p">(</span><span class="p">)</span>
</span></span></code></pre>
<p>I tested this function with the same HTML file in Docker and on my local machine. The image in the former raised a garbled text issue, but the latter worked fine. So I concluded that there must be a variable between the two that I hadn’t noticed.</p>

<p>So what's the differences ? English characters and Chineses characters ? A sudden flash of inspiration, <strong>How to make Chinese characters display properly on Chromium</strong>. All of these issues due to font weren't installed. After i installed the specified fonts, everything works well again.</p>

<h1 id="conclusion">Conclusion</h1>

<p>Even though the final result showed no issues with the code, it was still an interesting experience for me. To ensure your program works as excepted, you need to check not only your code but also the surrounding environments. Anything is possible.</p>

            </div>
            
            <div class="tag-list">
                
                <a href="/tags/python/" class="tag">python</a>
                
            </div>
            
            <div class="giscus">
                <script src="https://giscus.app/client.js"
                    data-repo="leetaogoooo/discussion-blog"
                    data-repo-id="R_kgDOIOm9Yg"
                    data-mapping="number"
                    data-term="246"
                    data-reactions-enabled="1"
                    data-emit-metadata="0"
                    data-input-position="top"
                    data-theme="light"
                    data-lang="en"
                    crossorigin="anonymous"
                    async>
                </script>
            </div>
            
        </article>
    </main>
    
    <footer>
        <p>&copy; Leetao. All rights reserved.</p>
    </footer>
    
    <script src="/js/theme-toggle.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            
            const giscusScript = document.querySelector('script[src^="https://giscus.app/client.js"]');
            const setGiscusTheme = (theme) => {
                if (giscusScript) {
                    const message = { setConfig: { theme: theme } };
                    const iframe = document.querySelector('.giscus-frame');
                    if (iframe) {
                        iframe.contentWindow.postMessage({ giscus: message }, 'https://giscus.app');
                    }
                }
            };
            const currentTheme = document.documentElement.getAttribute('data-theme') || 'light';
            setGiscusTheme(currentTheme);
            new MutationObserver((mutations) => {
                mutations.forEach(mutation => {
                    if (mutation.attributeName === 'data-theme') {
                        setGiscusTheme(mutation.target.getAttribute('data-theme'));
                    }
                });
            }).observe(document.documentElement, { attributes: true });


            
            function initCopyButtons() {
                document.querySelectorAll('pre.chroma').forEach((pre) => {
                    
                    const existingButton = pre.querySelector('.copy-button');
                    if (existingButton) {
                        existingButton.remove();
                    }
                    
                    const button = document.createElement('button');
                    button.className = 'copy-button';
                    button.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path></svg>';
                    
                    pre.style.position = 'relative';
                    pre.appendChild(button);
                    
                    button.addEventListener('click', () => {
                        const code = pre.querySelector('code');
                        if (code) {
                            navigator.clipboard.writeText(code.innerText).then(() => {
                                button.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M20 6L9 17l-5-5"></path></svg>';
                                setTimeout(() => {
                                    button.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path></svg>';
                                }, 2000);
                            });
                        }
                    });
                });
                const button = document.createElement('button');
                button.className = 'copy-button';
                button.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path></svg>';
                
                pre.style.position = 'relative';
                pre.appendChild(button);
                
                button.addEventListener('click', () => {
                    const code = pre.querySelector('code');
                    if (code) {
                        navigator.clipboard.writeText(code.innerText).then(() => {
                            button.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M20 6L9 17l-5-5"></path></svg>';
                            setTimeout(() => {
                                button.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path></svg>';
                            }, 2000);
                        });
                    }
                });
            }
            
            
            initCopyButtons();
            
            
            document.addEventListener('themeChanged', () => {
                initCopyButtons();
            });
        });
    </script>
</body>
</html>