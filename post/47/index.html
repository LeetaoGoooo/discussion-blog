<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Flask-Loginç”¨æˆ·ä¼šè¯ç®¡ç† - Leetao</title>
    <meta name="description" content="






æƒ³å¿…å¤§å®¶å¯¹ Flask-Login è¿™ä¸ª Flask æ‰©å±•è‚¯å®šä¸ä¼šé™Œç”Ÿ,æ¯•ç«Ÿä½œä¸ºä¸€ä¸ªåº”ç”¨,ç”¨æˆ·ç™»å½•ä¹‹å,ä»–ä»¬çš„è®¤è¯çŠ¶æ€æ˜¯éœ€è¦è¢«è®°å½•ä¸‹æ...">
    
    <link rel="icon" href="/favicon.svg" type="image/x-icon">
    
    <link rel="stylesheet" href="/styles/main.css">
    <link rel="stylesheet" href="/styles/chroma.css">
    <link rel="alternate" type="application/rss+xml" href="/rss.xml" title="RSS Feed">
</head>
<body class="container">
    <header class="site-header">
        <div class="site-header__left">
            <a href="/" class="site-title">Leetao</a>
            
            <p class="site-description">å†™æœ‰è¶£çš„ä»£ç ï¼Œåšæœ‰è¶£çš„äº‹</p>
            
        </div>
        <div class="site-header__right">
            <nav class="site-nav">
                <a href="/">Home</a>
                <a href="/tags/">Tags</a>
                <a href="/about/">About</a>
                <button class="theme-toggle" id="theme-toggle">
                    <svg class="theme-icon" viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                    </svg>
                </button>
            </nav>
        </div>
    </header>
    
    <main>
        <article class="post">
            <header class="post-header">
                <h1 class="post-title">Flask-Loginç”¨æˆ·ä¼šè¯ç®¡ç†</h1>
                <p class="post-meta">
                    By LeetaoGoooo on July 16, 2023
                </p>
            </header>
            
            <div class="post-content">
                <p>æƒ³å¿…å¤§å®¶å¯¹ Flask-Login è¿™ä¸ª Flask æ‰©å±•è‚¯å®šä¸ä¼šé™Œç”Ÿ,æ¯•ç«Ÿä½œä¸ºä¸€ä¸ªåº”ç”¨,ç”¨æˆ·ç™»å½•ä¹‹å,ä»–ä»¬çš„è®¤è¯çŠ¶æ€æ˜¯éœ€è¦è¢«è®°å½•ä¸‹æ¥çš„,æµè§ˆå…¶ä»–çš„é¡µé¢ä¹Ÿæ˜¯éœ€è¦ä½¿ç”¨è¿™ä¸ªçŠ¶æ€çš„,ä½†æ˜¯è¿™ä¸€è¿‡ç¨‹æ˜¯æ€ä¹ˆå‘æŒ¥ä½œç”¨çš„å‘¢?è®©æˆ‘ä»¬ä»æºç çš„å±‚æ¬¡ä¸Šç®€å•è®¤è¯†ä¸€ä¸‹.</p>

<h1 id="flask-login-ä½¿ç”¨çš„å‡†å¤‡">Flask-Login ä½¿ç”¨çš„å‡†å¤‡</h1>

<p>ä½¿ç”¨ flask-login çš„ä¹‹å‰,æˆ‘ä»¬å¿…é¡»è¦å®ç°ä¸‹è¿°å››ä¸ªæ–¹æ³•:
<img src="http://ww1.sinaimg.cn/large/006wYWbGly1fkur7vprn0j30n804kmxd.jpg" alt="" />
ä½†æ˜¯ä¸ºä»€ä¹ˆè¦å®ç°è¿™ä¸ªæ–¹æ³•å‘¢?åˆ«ç€æ€¥æˆ‘ä»¬åœ¨ä¸‹é¢ä¼šé‡Šç–‘.
é™¤æ­¤ä¹‹å¤–æˆ‘ä»¬è¿˜éœ€è¦å†™ä¸‹è¿°çš„è¿™æ ·çš„ä»£ç :</p>
<pre class="chroma"><code><span class="line"><span class="cl"><span class="nd">@login_manager.user_loader</span>
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">load_user</span><span class="p">(</span><span class="n">username</span><span class="p">)</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="n">query_user</span><span class="p">(</span><span class="n">username</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">curr_user</span> <span class="o">=</span> <span class="n">User</span><span class="p">(</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">curr_user</span><span class="o">.</span><span class="n">id</span> <span class="o">=</span> <span class="n">username</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">curr_user</span>
</span></span></code></pre>
<p>ä¸Šé¢çš„ä¸ºç”¨æˆ·çš„å›è°ƒå‡½æ•°æ¥æ”¶å­—ç¬¦ä¸²è¡¨ç¤ºçš„å”¯ä¸€ç”¨æˆ·æ ‡è¯†ç¬¦,å¦‚æœèƒ½æ‰¾åˆ°è¯¥ç”¨æˆ·,åˆ™è¿”å›è¯¥ç”¨æˆ·å¯¹è±¡å¦åˆ™è¿”å›None.ä½†æ˜¯<code>user_loader</code>ç©¶ç«Ÿæ˜¯ä»€ä¹ˆ?
æºç :</p>
<pre class="chroma"><code><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">LoginManager</span><span class="p">(</span><span class="nb">object</span><span class="p">)</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="o">.</span><span class="o">.</span><span class="o">.</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">user_loader</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">callback</span><span class="p">)</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">user_callback</span> <span class="o">=</span> <span class="n">callback</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">callback</span>
</span></span></code></pre>
<p>ä¼¼ä¹æ²¡ä»€ä¹ˆä½œç”¨å‘¢?åˆ«ç€æ€¥,æ¥ç€å¾€ä¸‹çœ‹,æˆ‘ä»¬é€šè¿‡å…·ä½“ä½¿ç”¨å»ç†è§£æºç </p>

<h1 id="login-user">login_user()</h1>

<p>ä½†å‡¡æ—¶å€™ Flask-Login åº”è¯¥éƒ½ç”¨è¿‡ <code>login_user()</code>,æ‰€ä»¥è®©æˆ‘ä»¬çœ‹çœ‹ä½¿ç”¨è¿™ä¸ªå‡½æ•°å‘ç”Ÿäº†ä»€ä¹ˆ.</p>
<pre class="chroma"><code><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">login_user</span><span class="p">(</span><span class="n">user</span><span class="p">,</span> <span class="n">remember</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">force</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">fresh</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="ow">not</span> <span class="n">force</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">user</span><span class="o">.</span><span class="n">is_active</span><span class="p">:</span> <span class="c1"># æœ€åˆå¿…é¡»å®ç°çš„å››ä¸ªæ–¹æ³•ä¹‹ä¸€,åœ¨è¿™é‡Œå‘æŒ¥ä½œç”¨,å¦‚æœè¯¥ç”¨æˆ·ä¸å…è®¸ç™»å½•åˆ™ç›´æ¥è¿”å›False(é»‘åå•etc)</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="kc">False</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">user_id</span> <span class="o">=</span> <span class="n">user</span><span class="o">.</span><span class="n">get_id</span><span class="p">(</span><span class="p">)</span> <span class="c1"># ä¿®æ”¹</span>
</span></span><span class="line"><span class="cl">    <span class="n">session</span><span class="p">[</span><span class="sa"></span><span class="s1">&#39;</span><span class="s1">user_id</span><span class="s1">&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">user_id</span>
</span></span><span class="line"><span class="cl">    <span class="n">session</span><span class="p">[</span><span class="sa"></span><span class="s1">&#39;</span><span class="s1">_fresh</span><span class="s1">&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">fresh</span>
</span></span><span class="line"><span class="cl">    <span class="n">session</span><span class="p">[</span><span class="sa"></span><span class="s1">&#39;</span><span class="s1">_id</span><span class="s1">&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">current_app</span><span class="o">.</span><span class="n">login_manager</span><span class="o">.</span><span class="n">_session_identifier_generator</span><span class="p">(</span><span class="p">)</span> <span class="c1"># æ ¹æ®å®¢æˆ·ç«¯çš„User Agentå’ŒIPç”Ÿæˆæ ‡è¯†,strongæ¨¡å¼ä¸‹ä¸€æ—¦ç”¨æˆ·æ ‡è¯†æ£€æµ‹å¤±è´¥,ä¾¿ä¼šæ¸…ç©ºæ‰€æœ‰çš„sessionå†…å®¹</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="n">remember</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">session</span><span class="p">[</span><span class="sa"></span><span class="s1">&#39;</span><span class="s1">remember</span><span class="s1">&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="sa"></span><span class="s1">&#39;</span><span class="s1">set</span><span class="s1">&#39;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">_request_ctx_stack</span><span class="o">.</span><span class="n">top</span><span class="o">.</span><span class="n">user</span> <span class="o">=</span> <span class="n">user</span>
</span></span><span class="line"><span class="cl">    <span class="n">user_logged_in</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">current_app</span><span class="o">.</span><span class="n">_get_current_object</span><span class="p">(</span><span class="p">)</span><span class="p">,</span> <span class="n">user</span><span class="o">=</span><span class="n">_get_user</span><span class="p">(</span><span class="p">)</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="kc">True</span>
</span></span></code></pre>
<p>ä¸»è¦å†…å®¹æ˜¯å°†ç”¨æˆ·ä¿¡æ¯æ”¾å…¥sessionä¸­,å¹¶ä¸ºæ”¹sessionç”Ÿæˆæ ‡è¯†ç¬¦.</p>

<h1 id="login-required">@login_required</h1>

<p>æˆ‘ä»¬é€šè¿‡ @login_required å»é™åˆ¶ç”¨æˆ·é¡µé¢è®¿é—®,è¿™ä¸€è¿‡ç¨‹æ˜¯æ€ä¹ˆå®ç°çš„?</p>
<pre class="chroma"><code><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">login_required</span><span class="p">(</span><span class="n">func</span><span class="p">)</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="nd">@wraps</span><span class="p">(</span><span class="n">func</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">decorated_view</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">*</span><span class="o">*</span><span class="n">kwargs</span><span class="p">)</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="ow">in</span> <span class="n">EXEMPT_METHODS</span><span class="p">:</span> <span class="o">/</span><span class="o">/</span> <span class="n">EXEMPT_METHODS</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="p">[</span><span class="sa"></span><span class="s1">&#39;</span><span class="s1">OPTIONS</span><span class="s1">&#39;</span><span class="p">]</span><span class="p">)</span> <span class="n">config</span><span class="o">.</span><span class="n">py</span> <span class="n">ç¬¬</span> <span class="mi">49</span> <span class="n">è¡Œ</span><span class="p">,</span><span class="n">é€šå¸¸è¯¥è¯·æ±‚æ˜¯è·å–æœåŠ¡å™¨æ”¯æŒçš„HTTPè¯·æ±‚æ–¹æ³•</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="n">func</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">*</span><span class="o">*</span><span class="n">kwargs</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">elif</span> <span class="n">current_app</span><span class="o">.</span><span class="n">login_manager</span><span class="o">.</span><span class="n">_login_disabled</span><span class="p">:</span> <span class="c1"># å¦‚æœ _login_disabled è¢«è®¾ç½®ä¸º True,åˆ™è£…é¥°å™¨å°†ä¼šè¢«å¿½ç•¥,é€šå¸¸ç”¨åœ¨å•å…ƒæµ‹è¯•å¯ä»¥å¾ˆæ–¹ä¾¿çš„å…³é—­è®¤è¯</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="n">func</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">*</span><span class="o">*</span><span class="n">kwargs</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">elif</span> <span class="ow">not</span> <span class="n">current_user</span><span class="o">.</span><span class="n">is_authenticated</span><span class="p">:</span> <span class="c1"># åˆ¤æ–­ç”¨æˆ·æ˜¯å¦ç™»å½•</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="n">current_app</span><span class="o">.</span><span class="n">login_manager</span><span class="o">.</span><span class="n">unauthorized</span><span class="p">(</span><span class="p">)</span> <span class="c1"># æ²¡æœ‰ç™»å½•çš„æƒ…å†µä¸‹:1.å¦‚æœæ³¨å†Œäº† LoginManager.unauthorized_handler åˆ™è¿™ä¸ªæ—¶å€™è°ƒç”¨è¿™ä¸ªå‡½æ•° 2. å‘ç”¨æˆ·æç¤º LoginManager.login_messageä¿¡æ¯ 3.æœ‰ login_viewçš„æƒ…å†µä¸‹,è·³è½¬åˆ°login_view,æ²¡æœ‰åˆ™è¿”å›abort(401)</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">func</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">*</span><span class="o">*</span><span class="n">kwargs</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">decorated_view</span>
</span></span></code></pre>
<h1 id="unauthorized">unauthorized()</h1>

<p>åœ¨ä¸Šè¿°<code>@login.required</code>ä¸­æˆ‘ä»¬è¯´æ˜äº†,<code>unauthorized()</code>åœ¨éœ€è¦ç™»å½•çš„æƒ…å†µä¸‹é‡‡å–çš„è¡ŒåŠ¨,ç°åœ¨ç®€å•çš„çœ‹ä¸€ä¸‹ä»£ç :</p>
<pre class="chroma"><code><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">unauthorized</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">user_unauthorized</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">current_app</span><span class="o">.</span><span class="n">_get_current_object</span><span class="p">(</span><span class="p">)</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">unauthorized_callback</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">unauthorized_callback</span><span class="p">(</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">blueprint</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">blueprint_login_views</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">login_view</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">blueprint_login_views</span><span class="p">[</span><span class="n">request</span><span class="o">.</span><span class="n">blueprint</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">        <span class="k">else</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">login_view</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">login_view</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="ow">not</span> <span class="n">login_view</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">abort</span><span class="p">(</span><span class="mi">401</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">login_message</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">localize_callback</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="n">flash</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">localize_callback</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">login_message</span><span class="p">)</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                      <span class="n">category</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">login_message_category</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">else</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="n">flash</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">login_message</span><span class="p">,</span> <span class="n">category</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">login_message_category</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">config</span> <span class="o">=</span> <span class="n">current_app</span><span class="o">.</span><span class="n">config</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="sa"></span><span class="s1">&#39;</span><span class="s1">USE_SESSION_FOR_NEXT</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">USE_SESSION_FOR_NEXT</span><span class="p">)</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">login_url</span> <span class="o">=</span> <span class="n">expand_login_view</span><span class="p">(</span><span class="n">login_view</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="n">session</span><span class="p">[</span><span class="sa"></span><span class="s1">&#39;</span><span class="s1">next</span><span class="s1">&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">make_next_param</span><span class="p">(</span><span class="n">login_url</span><span class="p">,</span> <span class="n">request</span><span class="o">.</span><span class="n">url</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="n">redirect_url</span> <span class="o">=</span> <span class="n">make_login_url</span><span class="p">(</span><span class="n">login_view</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">else</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">redirect_url</span> <span class="o">=</span> <span class="n">make_login_url</span><span class="p">(</span><span class="n">login_view</span><span class="p">,</span> <span class="n">next_url</span><span class="o">=</span><span class="n">request</span><span class="o">.</span><span class="n">url</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="n">redirect_url</span><span class="p">)</span>
</span></span></code></pre>
<h1 id="current-user">current_user</h1>

<p>åœ¨ç™»å½•ä¹‹å,æˆ‘ä»¬åœ¨éœ€è¦ä½¿ç”¨å½“å‰ç™»å½•å¯¹è±¡çš„æ—¶å€™,éƒ½ä¼šä½¿ç”¨ <code>current_user</code>,é‚£ä¹ˆå®ƒæ˜¯æ€ä¹ˆå‘æŒ¥ä½œç”¨çš„?</p>
<pre class="chroma"><code><span class="line"><span class="cl"><span class="n">current_user</span> <span class="o">=</span> <span class="n">LocalProxy</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="n">_get_user</span><span class="p">(</span><span class="p">)</span><span class="p">)</span> <span class="o">/</span><span class="o">/</span> <span class="n">å½“å‰ç”¨æˆ·çš„ä»£ç†</span><span class="p">,</span><span class="n">è¿™é‡Œé‡ç‚¹å…³æ³¨</span> <span class="n">_get_user</span><span class="p">(</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># _get_user()</span>
</span></span><span class="line"><span class="cl"><span class="c1"># è°ƒç”¨ login_user() ä¹‹åæ˜¾ç„¶ _request_ctx_stack.top ä¸­å­˜åœ¨ user,åˆ™ç›´æ¥è¿”å› </span>
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">_get_user</span><span class="p">(</span><span class="p">)</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="n">has_request_context</span><span class="p">(</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">_request_ctx_stack</span><span class="o">.</span><span class="n">top</span><span class="p">,</span> <span class="sa"></span><span class="s1">&#39;</span><span class="s1">user</span><span class="s1">&#39;</span><span class="p">)</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">current_app</span><span class="o">.</span><span class="n">login_manager</span><span class="o">.</span><span class="n">_load_user</span><span class="p">(</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">_request_ctx_stack</span><span class="o">.</span><span class="n">top</span><span class="p">,</span> <span class="sa"></span><span class="s1">&#39;</span><span class="s1">user</span><span class="s1">&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># é‚£ä¹ˆå¦‚æœä¸å­˜åœ¨,ä¼šå‘ç”Ÿä»€ä¹ˆ? è°ƒç”¨ _loder_user()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># _loader_user()</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">_load_user</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">user_accessed</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">current_app</span><span class="o">.</span><span class="n">_get_current_object</span><span class="p">(</span><span class="p">)</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">config</span> <span class="o">=</span> <span class="n">current_app</span><span class="o">.</span><span class="n">config</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="sa"></span><span class="s1">&#39;</span><span class="s1">SESSION_PROTECTION</span><span class="s1">&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">session_protection</span><span class="p">)</span><span class="p">:</span> <span class="o">/</span><span class="o">/</span> <span class="n">session</span> <span class="n">ä¿æŠ¤</span><span class="p">,</span><span class="n">å¯ä»¥å–å€¼ä¸º</span> <span class="kc">None</span><span class="p">(</span><span class="n">ç¦ç”¨</span><span class="p">)</span><span class="p">,</span><span class="n">basic</span><span class="p">(</span><span class="n">åœ¨</span> <span class="n">basic</span> <span class="n">æ¨¡å¼ä¸‹æˆ–ä¼šè¯æ˜¯æ°¸ä¹…çš„</span><span class="err">ï¼Œ</span><span class="n">å¦‚æœè¯¥æ ‡è¯†æœªåŒ¹é…</span><span class="err">ï¼Œ</span><span class="n">ä¼šè¯ä¼šç®€å•åœ°è¢«æ ‡è®°ä¸ºéæ´»</span> <span class="n">è·ƒçš„</span><span class="err">ï¼Œ</span><span class="n">ä¸”ä»»ä½•éœ€è¦æ´»è·ƒç™»å…¥çš„ä¸œè¥¿ä¼šå¼ºåˆ¶ç”¨æˆ·é‡æ–°éªŒè¯</span><span class="err">ï¼Œ</span><span class="n">å‰æä½ å·²ç»ä½¿ç”¨äº†æ´»è·ƒç™»å…¥æœºåˆ¶</span><span class="p">)</span><span class="p">,</span><span class="n">strong</span><span class="p">(</span><span class="n">åœ¨</span> <span class="n">strong</span> <span class="n">æ¨¡å¼ä¸‹çš„éæ°¸ä¹…ä¼šè¯</span><span class="err">ï¼Œ</span><span class="n">å¦‚æœè¯¥æ ‡è¯†æœªåŒ¹é…</span><span class="err">ï¼Œ</span><span class="n">æ•´ä¸ªä¼šè¯æˆ–è€…è®°ä½çš„ä»¤ç‰Œå¦‚æœå­˜åœ¨å°†ä¼šè¢«åˆ é™¤</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="n">deleted</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_session_protection</span><span class="p">(</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="n">deleted</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">reload_user</span><span class="p">(</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1"># å¦‚æœ è®°ä½ä½ çš„ cookie å­˜åœ¨,è€Œ session ä¸å­˜åœ¨,åˆ™ä¼šå°† cookie ä¸­çš„ user_id èµ‹å€¼ç»™ session</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># ä½†æ˜¯å¦‚æœè¿™ä¸ªæ—¶å€™å¤„äºç™»å‡ºçš„çŠ¶æ€çš„è¯,ä¼šå‘ç”Ÿä»€ä¹ˆå‘¢?</span>
</span></span><span class="line"><span class="cl">        <span class="n">is_missing_user_id</span> <span class="o">=</span> <span class="sa"></span><span class="s1">&#39;</span><span class="s1">user_id</span><span class="s1">&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">session</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">is_missing_user_id</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">cookie_name</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="sa"></span><span class="s1">&#39;</span><span class="s1">REMEMBER_COOKIE_NAME</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">COOKIE_NAME</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="n">header_name</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="sa"></span><span class="s1">&#39;</span><span class="s1">AUTH_HEADER_NAME</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">AUTH_HEADER_NAME</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="n">has_cookie</span> <span class="o">=</span> <span class="p">(</span><span class="n">cookie_name</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">cookies</span> <span class="ow">and</span>
</span></span><span class="line"><span class="cl">                          <span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="sa"></span><span class="s1">&#39;</span><span class="s1">remember</span><span class="s1">&#39;</span><span class="p">)</span> <span class="o">!=</span> <span class="sa"></span><span class="s1">&#39;</span><span class="s1">clear</span><span class="s1">&#39;</span><span class="p">)</span> <span class="o">/</span><span class="o">/</span> <span class="n">ç™»å‡ºçš„æ—¶å€™</span> <span class="n">has_cookie</span> <span class="o">=</span> <span class="kc">False</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="n">has_cookie</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_load_from_cookie</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">cookies</span><span class="p">[</span><span class="n">cookie_name</span><span class="p">]</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">request_callback</span><span class="p">:</span> <span class="o">/</span><span class="o">/</span><span class="n">å®šä¹‰åœ¨</span> <span class="n">request_loader</span><span class="p">(</span><span class="p">)</span> <span class="n">ä¸­</span><span class="p">,</span> <span class="n">æ­£å¸¸æƒ…å†µä¸‹æˆ‘ä»¬å¹¶ä¸ä½¿ç”¨</span><span class="p">,</span><span class="n">ä»…å½“æˆ‘ä»¬ä¸æƒ³ä½¿ç”¨</span> <span class="n">cookie</span> <span class="n">çš„æƒ…å†µä¸‹ç™»å½•ç”¨æˆ·æ‰ä¼šè€ƒè™‘</span> <span class="n">request_loader</span> <span class="n">å›è°ƒ</span><span class="o">.</span>
</span></span><span class="line"><span class="cl">                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_load_from_request</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">elif</span> <span class="n">header_name</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">headers</span><span class="p">:</span> 
</span></span><span class="line"><span class="cl">                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_load_from_header</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">headers</span><span class="p">[</span><span class="n">header_name</span><span class="p">]</span><span class="p">)</span> <span class="c1"># è¯¥å‡½æ•°è°ƒç”¨é“¾ä¸­çš„ header_loader() å·²ç»è¢«å¼ƒç”¨</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">reload_user</span><span class="p">(</span><span class="p">)</span>
</span></span></code></pre>
<h1 id="logout-user">logout_user()</h1>

<p>ç™»å½•è¦éªŒè¯è´¦æˆ·å¯†ç ä»€ä¹ˆçš„,æ˜¾çš„æ¯”è¾ƒå¤æ‚,ä½†æ˜¯ç™»å‡ºå°±å¾ˆç®€ç­”äº†,ä½ ä¸éœ€è¦ä¼ é€’ä»»ä½•å‚æ•°,åªéœ€è°ƒç”¨è¿™ä¸ªå‡½æ•°,é‚£è®©æˆ‘ä»¬çœ‹çœ‹è¿™ä¸ªå‡½æ•°å‘ç”Ÿäº†ä»€ä¹ˆ:</p>
<pre class="chroma"><code><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">logout_user</span><span class="p">(</span><span class="p">)</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="n">user</span> <span class="o">=</span> <span class="n">_get_user</span><span class="p">(</span><span class="p">)</span> <span class="c1"># ä»_request_ctx_stack.top.user,session æˆ–è€… remember_me cookie ä¸­è·å–</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="sa"></span><span class="s1">&#39;</span><span class="s1">user_id</span><span class="s1">&#39;</span> <span class="ow">in</span> <span class="n">session</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">session</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="sa"></span><span class="s1">&#39;</span><span class="s1">user_id</span><span class="s1">&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="sa"></span><span class="s1">&#39;</span><span class="s1">_fresh</span><span class="s1">&#39;</span> <span class="ow">in</span> <span class="n">session</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">session</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="sa"></span><span class="s1">&#39;</span><span class="s1">_fresh</span><span class="s1">&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">cookie_name</span> <span class="o">=</span> <span class="n">current_app</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="sa"></span><span class="s1">&#39;</span><span class="s1">REMEMBER_COOKIE_NAME</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">COOKIE_NAME</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="n">cookie_name</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">cookies</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">session</span><span class="p">[</span><span class="sa"></span><span class="s1">&#39;</span><span class="s1">remember</span><span class="s1">&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="sa"></span><span class="s1">&#39;</span><span class="s1">clear</span><span class="s1">&#39;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">user_logged_out</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">current_app</span><span class="o">.</span><span class="n">_get_current_object</span><span class="p">(</span><span class="p">)</span><span class="p">,</span> <span class="n">user</span><span class="o">=</span><span class="n">user</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">current_app</span><span class="o">.</span><span class="n">login_manager</span><span class="o">.</span><span class="n">reload_user</span><span class="p">(</span><span class="p">)</span> 
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="kc">True</span>
</span></span></code></pre>
<p>è¯¥å‡½æ•°å°†sessionä¸­çš„userç›¸å…³ä¿¡æ¯å…¨éƒ¨æ¸…ç©º,ç„¶åé‡æ–°åŠ è½½ç”¨æˆ·,æ­£å¸¸é€»è¾‘ä¸‹ç”±äºé‡æ–°åŠ è½½ç”¨æˆ·åå¦‚æœå½“å‰é¡µé¢éœ€è¦ç™»å½•æ‰èƒ½è®¿é—®çš„è¯,åˆ™ä¼šè·³è½¬åˆ°ç™»å½•è§†å›¾.</p>

<h1 id="fresh-login-required">fresh_login_required</h1>

<p>å½“ç”¨æˆ·ç™»å…¥ï¼Œä»–ä»¬çš„ä¼šè¯è¢«æ ‡è®°æˆâ€œæ–°é²œçš„â€ï¼Œå°±æ˜¯è¯´åœ¨è¿™ä¸ªä¼šè¯åªä¸­ç”¨æˆ·å®é™…ä¸Šç™»å½•è¿‡ã€‚å½“ä¼šè¯é”€æ¯ç”¨æˆ·ä½¿ç”¨â€œè®°ä½æˆ‘â€çš„ cookie é‡æ–°ç™»å…¥ï¼Œä¼šè¯è¢«æ ‡è®°æˆâ€œéæ–°é²œçš„â€ã€‚fresh_login_required é™¤äº†éªŒè¯ç”¨æˆ·ç™»å½•ï¼Œä¹Ÿå°†ç¡®ä¿ä»–ä»¬çš„ç™»å½•æ˜¯â€œæ–°é²œçš„â€ã€‚å¦‚æœä¸æ˜¯â€œæ–°é²œçš„â€ï¼Œå®ƒä¼šæŠŠç”¨æˆ·é€åˆ°å¯ä»¥é‡è¾“å…¥éªŒè¯æ¡ä»¶çš„é¡µé¢,ä¸»è¦ç”¨æˆ·ä¿®æ”¹ä¸ªäººä¿¡æ¯çš„æ•æ„Ÿæ“ä½œ.</p>
<pre class="chroma"><code><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">fresh_login_required</span><span class="p">(</span><span class="n">func</span><span class="p">)</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="nd">@wraps</span><span class="p">(</span><span class="n">func</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">decorated_view</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">*</span><span class="o">*</span><span class="n">kwargs</span><span class="p">)</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="ow">in</span> <span class="n">EXEMPT_METHODS</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="n">func</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">*</span><span class="o">*</span><span class="n">kwargs</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">elif</span> <span class="n">current_app</span><span class="o">.</span><span class="n">login_manager</span><span class="o">.</span><span class="n">_login_disabled</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="n">func</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">*</span><span class="o">*</span><span class="n">kwargs</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">elif</span> <span class="ow">not</span> <span class="n">current_user</span><span class="o">.</span><span class="n">is_authenticated</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="n">current_app</span><span class="o">.</span><span class="n">login_manager</span><span class="o">.</span><span class="n">unauthorized</span><span class="p">(</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">elif</span> <span class="ow">not</span> <span class="n">login_fresh</span><span class="p">(</span><span class="p">)</span><span class="p">:</span> <span class="o">/</span><span class="o">/</span> <span class="n">è·å–session</span> <span class="n">ä¸­çš„</span> <span class="n">refresh</span> <span class="n">å€¼</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="n">current_app</span><span class="o">.</span><span class="n">login_manager</span><span class="o">.</span><span class="n">needs_refresh</span><span class="p">(</span><span class="p">)</span> <span class="o">/</span><span class="o">/</span> <span class="mf">1.</span><span class="n">å‡ºç°</span> <span class="n">LoginMange</span><span class="o">.</span><span class="n">needs_refress_message</span> <span class="mf">2.</span><span class="n">è·³è½¬åˆ°</span> <span class="n">LoginManger</span><span class="o">.</span><span class="n">refresh_view</span><span class="p">,</span><span class="n">å¦‚æœæ²¡æœ‰è®¾ç½®åˆ™ä¼šæç¤º</span> <span class="mi">401</span> <span class="n">é”™è¯¯</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">func</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">*</span><span class="o">*</span><span class="n">kwargs</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">decorated_view</span>
</span></span></code></pre>
<h1 id="confirm-login">confirm_login</h1>

<p>å°†ä¼šè¯é‡æ–°æ ‡è®°ä¸º&quot;æ–°é²œ&quot;</p>
<pre class="chroma"><code><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">confirm_login</span><span class="p">(</span><span class="p">)</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="n">session</span><span class="p">[</span><span class="sa"></span><span class="s1">&#39;</span><span class="s1">_fresh</span><span class="s1">&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
</span></span><span class="line"><span class="cl">    <span class="n">session</span><span class="p">[</span><span class="sa"></span><span class="s1">&#39;</span><span class="s1">_id</span><span class="s1">&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">current_app</span><span class="o">.</span><span class="n">login_manager</span><span class="o">.</span><span class="n">_session_identifier_generator</span><span class="p">(</span><span class="p">)</span> <span class="o">/</span><span class="o">/</span> <span class="n">é‡æ–°ç”Ÿæˆä¼šè¯id</span>
</span></span><span class="line"><span class="cl">    <span class="n">user_login_confirmed</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">current_app</span><span class="o">.</span><span class="n">_get_current_object</span><span class="p">(</span><span class="p">)</span><span class="p">)</span>
</span></span></code></pre>
<h1 id="reload-user">reload_user()</h1>

<p>æ¥ç€ <code>logout_user()</code> ä¸­è°ƒç”¨ <code>reload_user()</code>.å¾ˆæ˜¾ç„¶è¿™ä¸ªå‡½æ•°çš„åŠŸèƒ½å°±æ˜¯é‡æ–°åŠ è½½ç”¨æˆ·,å…·ä½“å®ç°è®©æˆ‘ä»¬çœ‹ä¸‹æºç </p>
<pre class="chroma"><code><span class="line"><span class="cl"><span class="c1"># logout_user() ä¸­è°ƒç”¨, user ä½¿ç”¨é»˜è®¤å‚æ•°ä¸º None</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">reload_user</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">user</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">ctx</span> <span class="o">=</span> <span class="n">_request_ctx_stack</span><span class="o">.</span><span class="n">top</span> <span class="o">/</span><span class="o">/</span> <span class="n">_request_ctx_stack</span> <span class="n">ä¸€ä¸ªä¿å­˜å¯¹è±¡çš„æ ˆ</span><span class="p">,</span><span class="n">å¯ä»¥è¿”å›çœ‹</span> <span class="n">login_user</span><span class="p">(</span><span class="p">)</span> <span class="n">æºç çš„å€’æ•°ç¬¬ä¸‰è¡Œ</span><span class="p">,</span><span class="n">ç™»å½•çš„æ—¶å€™å°†</span> <span class="n">user</span> <span class="n">ä¿å­˜åœ¨</span> <span class="n">_request_ctx_stack</span><span class="o">.</span><span class="n">top</span><span class="o">.</span><span class="n">user</span> <span class="n">ä¸­</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">user</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> 
</span></span><span class="line"><span class="cl">            <span class="n">user_id</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="sa"></span><span class="s1">&#39;</span><span class="s1">user_id</span><span class="s1">&#39;</span><span class="p">)</span> <span class="o">/</span><span class="o">/</span> <span class="n">logout_user</span><span class="p">(</span><span class="p">)</span> <span class="n">ä¸­</span> <span class="n">session</span> <span class="n">å·²ç»å°†</span> <span class="n">user_id</span> <span class="n">ç§»é™¤</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="n">user_id</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="n">ctx</span><span class="o">.</span><span class="n">user</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">anonymous_user</span><span class="p">(</span><span class="p">)</span> <span class="o">/</span><span class="o">/</span><span class="n">è§ä¸‹æ–‡</span>
</span></span><span class="line"><span class="cl">            <span class="k">else</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">user_callback</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="o">/</span><span class="o">/</span><span class="n">è¿™é‡Œè§£é‡Šäº†ä¸ºä»€ä¹ˆæˆ‘ä»¬éœ€è¦å®šä¹‰</span> <span class="nd">@login_manager.user_loader</span>
</span></span><span class="line"><span class="cl">                    <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">                        <span class="sa"></span><span class="s2">&#34;</span><span class="s2">No user_loader has been installed for this </span><span class="s2">&#34;</span>
</span></span><span class="line"><span class="cl">                        <span class="sa"></span><span class="s2">&#34;</span><span class="s2">LoginManager. Add one with the </span><span class="s2">&#34;</span>
</span></span><span class="line"><span class="cl">                        <span class="sa"></span><span class="s2">&#34;</span><span class="s2">&#39;</span><span class="s2">LoginManager.user_loader</span><span class="s2">&#39;</span><span class="s2"> decorator.</span><span class="s2">&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="n">user</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">user_callback</span><span class="p">(</span><span class="n">user_id</span><span class="p">)</span> <span class="o">/</span><span class="o">/</span> <span class="n">è¿™é‡Œæˆ‘ä»¬æœ€åˆå®šä¹‰çš„user_loaderå‘æŒ¥ä½œç”¨</span><span class="p">,</span><span class="n">é€šè¿‡è°ƒç”¨self</span><span class="o">.</span><span class="n">user_callback</span><span class="p">(</span><span class="p">)</span><span class="n">è·å–ç”¨æˆ·</span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="n">user</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                    <span class="n">ctx</span><span class="o">.</span><span class="n">user</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">anonymous_user</span><span class="p">(</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="k">else</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                    <span class="n">ctx</span><span class="o">.</span><span class="n">user</span> <span class="o">=</span> <span class="n">user</span>
</span></span><span class="line"><span class="cl">        <span class="k">else</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">ctx</span><span class="o">.</span><span class="n">user</span> <span class="o">=</span> <span class="n">user</span>
</span></span></code></pre>
<h1 id="anoymous-user">anoymous_user</h1>

<p>æºç å¦‚ä¸‹:</p>
<pre class="chroma"><code><span class="line"><span class="cl"><span class="bp">self</span><span class="o">.</span><span class="n">anonymous_user</span> <span class="o">=</span> <span class="n">AnonymousUserMixin</span> <span class="o">/</span><span class="o">/</span> <span class="n">åŒ¿åç±»</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># AnonymousUserMixin</span>
</span></span><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">AnonymousUserMixin</span><span class="p">(</span><span class="nb">object</span><span class="p">)</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="nd">@property</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">is_authenticated</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="kc">False</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nd">@property</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">is_active</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="kc">False</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nd">@property</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">is_anonymous</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="kc">True</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">get_id</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span>
</span></span></code></pre>
            </div>
            
            <div class="tag-list">
                
            </div>
            
            <div class="giscus">
                <script src="https://giscus.app/client.js"
                    data-repo="leetaogoooo/discussion-blog"
                    data-repo-id="R_kgDOIOm9Yg"
                    data-mapping="number"
                    data-term="47"
                    data-reactions-enabled="1"
                    data-emit-metadata="0"
                    data-input-position="top"
                    data-theme="light"
                    data-lang="en"
                    crossorigin="anonymous"
                    async>
                </script>
            </div>
            
        </article>
    </main>
    
    <footer>
        <p>&copy; Leetao. All rights reserved.</p>
    </footer>
    
    <script src="/js/theme-toggle.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            
            const giscusScript = document.querySelector('script[src^="https://giscus.app/client.js"]');
            const setGiscusTheme = (theme) => {
                if (giscusScript) {
                    const message = { setConfig: { theme: theme } };
                    const iframe = document.querySelector('.giscus-frame');
                    if (iframe) {
                        iframe.contentWindow.postMessage({ giscus: message }, 'https://giscus.app');
                    }
                }
            };
            const currentTheme = document.documentElement.getAttribute('data-theme') || 'light';
            setGiscusTheme(currentTheme);
            new MutationObserver((mutations) => {
                mutations.forEach(mutation => {
                    if (mutation.attributeName === 'data-theme') {
                        setGiscusTheme(mutation.target.getAttribute('data-theme'));
                    }
                });
            }).observe(document.documentElement, { attributes: true });


            
            function initCopyButtons() {
                document.querySelectorAll('pre.chroma').forEach((pre) => {
                    
                    const existingButton = pre.querySelector('.copy-button');
                    if (existingButton) {
                        existingButton.remove();
                    }
                    
                    const button = document.createElement('button');
                    button.className = 'copy-button';
                    button.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path></svg>';
                    
                    pre.style.position = 'relative';
                    pre.appendChild(button);
                    
                    button.addEventListener('click', () => {
                        const code = pre.querySelector('code');
                        if (code) {
                            navigator.clipboard.writeText(code.innerText).then(() => {
                                button.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M20 6L9 17l-5-5"></path></svg>';
                                setTimeout(() => {
                                    button.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path></svg>';
                                }, 2000);
                            });
                        }
                    });
                });
                const button = document.createElement('button');
                button.className = 'copy-button';
                button.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path></svg>';
                
                pre.style.position = 'relative';
                pre.appendChild(button);
                
                button.addEventListener('click', () => {
                    const code = pre.querySelector('code');
                    if (code) {
                        navigator.clipboard.writeText(code.innerText).then(() => {
                            button.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M20 6L9 17l-5-5"></path></svg>';
                            setTimeout(() => {
                                button.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path></svg>';
                            }, 2000);
                        });
                    }
                });
            }
            
            
            initCopyButtons();
            
            
            document.addEventListener('themeChanged', () => {
                initCopyButtons();
            });
        });
    </script>
</body>
</html>