<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Flask-Loginç”¨æˆ·ä¼šè¯ç®¡ç† - Leetao</title>
    <meta name="description" content="






æƒ³å¿…å¤§å®¶å¯¹ Flask-Login è¿™ä¸ª Flask æ‰©å±•è‚¯å®šä¸ä¼šé™Œç”Ÿ,æ¯•ç«Ÿä½œä¸ºä¸€ä¸ªåº”ç”¨,ç”¨æˆ·ç™»å½•ä¹‹å,ä»–ä»¬çš„è®¤è¯çŠ¶æ€æ˜¯éœ€è¦è¢«è®°å½•ä¸‹æ...">
    
    <link rel="icon" href="/favicon.svg" type="image/x-icon">
    
    <link rel="stylesheet" href="/styles/main.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/default.min.css">
</head>
<body>
    <header>
        <h1><a href="/">Leetao</a></h1>
        
        <p class="site-description">å†™æœ‰è¶£çš„ä»£ç ï¼Œåšæœ‰è¶£çš„äº‹</p>
        
        <nav>
            <ul>
                <li><a href="/">Home</a></li>
                <li><a href="/tags/">Tags</a></li>
                <li><a href="/about/">About</a></li>
                <li><button class="theme-toggle" id="theme-toggle">
                    <svg class="theme-icon" viewBox="0 0 24 24" width="16" height="16">
                        <path d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"/>
                    </svg>
                    Theme
                </button></li>
            </ul>
        </nav>
    </header>
    
    <main>
        <article class="post">
            <h1>Flask-Loginç”¨æˆ·ä¼šè¯ç®¡ç†</h1>
            <p class="meta">
                By LeetaoGoooo on July 16, 2023
            </p>
            
            <div class="content">
                <p>æƒ³å¿…å¤§å®¶å¯¹ Flask-Login è¿™ä¸ª Flask æ‰©å±•è‚¯å®šä¸ä¼šé™Œç”Ÿ,æ¯•ç«Ÿä½œä¸ºä¸€ä¸ªåº”ç”¨,ç”¨æˆ·ç™»å½•ä¹‹å,ä»–ä»¬çš„è®¤è¯çŠ¶æ€æ˜¯éœ€è¦è¢«è®°å½•ä¸‹æ¥çš„,æµè§ˆå…¶ä»–çš„é¡µé¢ä¹Ÿæ˜¯éœ€è¦ä½¿ç”¨è¿™ä¸ªçŠ¶æ€çš„,ä½†æ˜¯è¿™ä¸€è¿‡ç¨‹æ˜¯æ€ä¹ˆå‘æŒ¥ä½œç”¨çš„å‘¢?è®©æˆ‘ä»¬ä»æºç çš„å±‚æ¬¡ä¸Šç®€å•è®¤è¯†ä¸€ä¸‹.</p>

<h1>Flask-Login ä½¿ç”¨çš„å‡†å¤‡</h1>

<p>ä½¿ç”¨ flask-login çš„ä¹‹å‰,æˆ‘ä»¬å¿…é¡»è¦å®ç°ä¸‹è¿°å››ä¸ªæ–¹æ³•:
<img src="http://ww1.sinaimg.cn/large/006wYWbGly1fkur7vprn0j30n804kmxd.jpg" alt="" />
ä½†æ˜¯ä¸ºä»€ä¹ˆè¦å®ç°è¿™ä¸ªæ–¹æ³•å‘¢?åˆ«ç€æ€¥æˆ‘ä»¬åœ¨ä¸‹é¢ä¼šé‡Šç–‘.
é™¤æ­¤ä¹‹å¤–æˆ‘ä»¬è¿˜éœ€è¦å†™ä¸‹è¿°çš„è¿™æ ·çš„ä»£ç :</p>

<pre><code class="language-python">@login_manager.user_loader
def load_user(username):
    if query_user(username) is not None:
        curr_user = User()
        curr_user.id = username
        return curr_user
</code></pre>

<p>ä¸Šé¢çš„ä¸ºç”¨æˆ·çš„å›è°ƒå‡½æ•°æ¥æ”¶å­—ç¬¦ä¸²è¡¨ç¤ºçš„å”¯ä¸€ç”¨æˆ·æ ‡è¯†ç¬¦,å¦‚æœèƒ½æ‰¾åˆ°è¯¥ç”¨æˆ·,åˆ™è¿”å›è¯¥ç”¨æˆ·å¯¹è±¡å¦åˆ™è¿”å›None.ä½†æ˜¯<code>user_loader</code>ç©¶ç«Ÿæ˜¯ä»€ä¹ˆ?
æºç :</p>

<pre><code class="language-python">class LoginManager(object):
    ...
    def user_loader(self, callback):
        self.user_callback = callback
        return callback
</code></pre>

<p>ä¼¼ä¹æ²¡ä»€ä¹ˆä½œç”¨å‘¢?åˆ«ç€æ€¥,æ¥ç€å¾€ä¸‹çœ‹,æˆ‘ä»¬é€šè¿‡å…·ä½“ä½¿ç”¨å»ç†è§£æºç </p>

<h1>login_user()</h1>

<p>ä½†å‡¡æ—¶å€™ Flask-Login åº”è¯¥éƒ½ç”¨è¿‡ <code>login_user()</code>,æ‰€ä»¥è®©æˆ‘ä»¬çœ‹çœ‹ä½¿ç”¨è¿™ä¸ªå‡½æ•°å‘ç”Ÿäº†ä»€ä¹ˆ.</p>

<pre><code class="language-python">def login_user(user, remember=False, force=False, fresh=True):
    if not force and not user.is_active: # æœ€åˆå¿…é¡»å®ç°çš„å››ä¸ªæ–¹æ³•ä¹‹ä¸€,åœ¨è¿™é‡Œå‘æŒ¥ä½œç”¨,å¦‚æœè¯¥ç”¨æˆ·ä¸å…è®¸ç™»å½•åˆ™ç›´æ¥è¿”å›False(é»‘åå•etc)
        return False

    user_id = user.get_id() # ä¿®æ”¹
    session['user_id'] = user_id
    session['_fresh'] = fresh
    session['_id'] = current_app.login_manager._session_identifier_generator() # æ ¹æ®å®¢æˆ·ç«¯çš„User Agentå’ŒIPç”Ÿæˆæ ‡è¯†,strongæ¨¡å¼ä¸‹ä¸€æ—¦ç”¨æˆ·æ ‡è¯†æ£€æµ‹å¤±è´¥,ä¾¿ä¼šæ¸…ç©ºæ‰€æœ‰çš„sessionå†…å®¹

    if remember:
        session['remember'] = 'set'

    _request_ctx_stack.top.user = user
    user_logged_in.send(current_app._get_current_object(), user=_get_user())
    return True
</code></pre>

<p>ä¸»è¦å†…å®¹æ˜¯å°†ç”¨æˆ·ä¿¡æ¯æ”¾å…¥sessionä¸­,å¹¶ä¸ºæ”¹sessionç”Ÿæˆæ ‡è¯†ç¬¦.</p>

<h1>@login_required</h1>

<p>æˆ‘ä»¬é€šè¿‡ @login_required å»é™åˆ¶ç”¨æˆ·é¡µé¢è®¿é—®,è¿™ä¸€è¿‡ç¨‹æ˜¯æ€ä¹ˆå®ç°çš„?</p>

<pre><code class="language-python">def login_required(func):
    @wraps(func)
    def decorated_view(*args, **kwargs):
        if request.method in EXEMPT_METHODS: // EXEMPT_METHODS = set(['OPTIONS']) config.py ç¬¬ 49 è¡Œ,é€šå¸¸è¯¥è¯·æ±‚æ˜¯è·å–æœåŠ¡å™¨æ”¯æŒçš„HTTPè¯·æ±‚æ–¹æ³•
            return func(*args, **kwargs)
        elif current_app.login_manager._login_disabled: # å¦‚æœ _login_disabled è¢«è®¾ç½®ä¸º True,åˆ™è£…é¥°å™¨å°†ä¼šè¢«å¿½ç•¥,é€šå¸¸ç”¨åœ¨å•å…ƒæµ‹è¯•å¯ä»¥å¾ˆæ–¹ä¾¿çš„å…³é—­è®¤è¯
            return func(*args, **kwargs)
        elif not current_user.is_authenticated: # åˆ¤æ–­ç”¨æˆ·æ˜¯å¦ç™»å½•
            return current_app.login_manager.unauthorized() # æ²¡æœ‰ç™»å½•çš„æƒ…å†µä¸‹:1.å¦‚æœæ³¨å†Œäº† LoginManager.unauthorized_handler åˆ™è¿™ä¸ªæ—¶å€™è°ƒç”¨è¿™ä¸ªå‡½æ•° 2. å‘ç”¨æˆ·æç¤º LoginManager.login_messageä¿¡æ¯ 3.æœ‰ login_viewçš„æƒ…å†µä¸‹,è·³è½¬åˆ°login_view,æ²¡æœ‰åˆ™è¿”å›abort(401)
        return func(*args, **kwargs)
    return decorated_view
</code></pre>

<h1>unauthorized()</h1>

<p>åœ¨ä¸Šè¿°<code>@login.required</code>ä¸­æˆ‘ä»¬è¯´æ˜äº†,<code>unauthorized()</code>åœ¨éœ€è¦ç™»å½•çš„æƒ…å†µä¸‹é‡‡å–çš„è¡ŒåŠ¨,ç°åœ¨ç®€å•çš„çœ‹ä¸€ä¸‹ä»£ç :</p>

<pre><code class="language-python">    def unauthorized(self):
        user_unauthorized.send(current_app._get_current_object())

        if self.unauthorized_callback:
            return self.unauthorized_callback()

        if request.blueprint in self.blueprint_login_views:
            login_view = self.blueprint_login_views[request.blueprint]
        else:
            login_view = self.login_view

        if not login_view:
            abort(401)

        if self.login_message:
            if self.localize_callback is not None:
                flash(self.localize_callback(self.login_message),
                      category=self.login_message_category)
            else:
                flash(self.login_message, category=self.login_message_category)

        config = current_app.config
        if config.get('USE_SESSION_FOR_NEXT', USE_SESSION_FOR_NEXT):
            login_url = expand_login_view(login_view)
            session['next'] = make_next_param(login_url, request.url)
            redirect_url = make_login_url(login_view)
        else:
            redirect_url = make_login_url(login_view, next_url=request.url)

        return redirect(redirect_url)
</code></pre>

<h1>current_user</h1>

<p>åœ¨ç™»å½•ä¹‹å,æˆ‘ä»¬åœ¨éœ€è¦ä½¿ç”¨å½“å‰ç™»å½•å¯¹è±¡çš„æ—¶å€™,éƒ½ä¼šä½¿ç”¨ <code>current_user</code>,é‚£ä¹ˆå®ƒæ˜¯æ€ä¹ˆå‘æŒ¥ä½œç”¨çš„?</p>

<pre><code class="language-python">current_user = LocalProxy(lambda: _get_user()) // å½“å‰ç”¨æˆ·çš„ä»£ç†,è¿™é‡Œé‡ç‚¹å…³æ³¨ _get_user()

# _get_user()
# è°ƒç”¨ login_user() ä¹‹åæ˜¾ç„¶ _request_ctx_stack.top ä¸­å­˜åœ¨ user,åˆ™ç›´æ¥è¿”å› 
def _get_user():
    if has_request_context() and not hasattr(_request_ctx_stack.top, 'user'):
        current_app.login_manager._load_user()

    return getattr(_request_ctx_stack.top, 'user', None)

# é‚£ä¹ˆå¦‚æœä¸å­˜åœ¨,ä¼šå‘ç”Ÿä»€ä¹ˆ? è°ƒç”¨ _loder_user()

# _loader_user()
    def _load_user(self):
        user_accessed.send(current_app._get_current_object())

        config = current_app.config
        if config.get('SESSION_PROTECTION', self.session_protection): // session ä¿æŠ¤,å¯ä»¥å–å€¼ä¸º None(ç¦ç”¨),basic(åœ¨ basic æ¨¡å¼ä¸‹æˆ–ä¼šè¯æ˜¯æ°¸ä¹…çš„ï¼Œå¦‚æœè¯¥æ ‡è¯†æœªåŒ¹é…ï¼Œä¼šè¯ä¼šç®€å•åœ°è¢«æ ‡è®°ä¸ºéæ´» è·ƒçš„ï¼Œä¸”ä»»ä½•éœ€è¦æ´»è·ƒç™»å…¥çš„ä¸œè¥¿ä¼šå¼ºåˆ¶ç”¨æˆ·é‡æ–°éªŒè¯ï¼Œå‰æä½ å·²ç»ä½¿ç”¨äº†æ´»è·ƒç™»å…¥æœºåˆ¶),strong(åœ¨ strong æ¨¡å¼ä¸‹çš„éæ°¸ä¹…ä¼šè¯ï¼Œå¦‚æœè¯¥æ ‡è¯†æœªåŒ¹é…ï¼Œæ•´ä¸ªä¼šè¯æˆ–è€…è®°ä½çš„ä»¤ç‰Œå¦‚æœå­˜åœ¨å°†ä¼šè¢«åˆ é™¤)
            deleted = self._session_protection()
            if deleted:
                return self.reload_user()

        # å¦‚æœ è®°ä½ä½ çš„ cookie å­˜åœ¨,è€Œ session ä¸å­˜åœ¨,åˆ™ä¼šå°† cookie ä¸­çš„ user_id èµ‹å€¼ç»™ session
        # ä½†æ˜¯å¦‚æœè¿™ä¸ªæ—¶å€™å¤„äºç™»å‡ºçš„çŠ¶æ€çš„è¯,ä¼šå‘ç”Ÿä»€ä¹ˆå‘¢?
        is_missing_user_id = 'user_id' not in session
        if is_missing_user_id:
            cookie_name = config.get('REMEMBER_COOKIE_NAME', COOKIE_NAME)
            header_name = config.get('AUTH_HEADER_NAME', AUTH_HEADER_NAME)
            has_cookie = (cookie_name in request.cookies and
                          session.get('remember') != 'clear') // ç™»å‡ºçš„æ—¶å€™ has_cookie = False
            if has_cookie:
                return self._load_from_cookie(request.cookies[cookie_name])
            elif self.request_callback: //å®šä¹‰åœ¨ request_loader() ä¸­, æ­£å¸¸æƒ…å†µä¸‹æˆ‘ä»¬å¹¶ä¸ä½¿ç”¨,ä»…å½“æˆ‘ä»¬ä¸æƒ³ä½¿ç”¨ cookie çš„æƒ…å†µä¸‹ç™»å½•ç”¨æˆ·æ‰ä¼šè€ƒè™‘ request_loader å›è°ƒ.
                return self._load_from_request(request)
            elif header_name in request.headers: 
                return self._load_from_header(request.headers[header_name]) # è¯¥å‡½æ•°è°ƒç”¨é“¾ä¸­çš„ header_loader() å·²ç»è¢«å¼ƒç”¨

        return self.reload_user()
</code></pre>

<h1>logout_user()</h1>

<p>ç™»å½•è¦éªŒè¯è´¦æˆ·å¯†ç ä»€ä¹ˆçš„,æ˜¾çš„æ¯”è¾ƒå¤æ‚,ä½†æ˜¯ç™»å‡ºå°±å¾ˆç®€ç­”äº†,ä½ ä¸éœ€è¦ä¼ é€’ä»»ä½•å‚æ•°,åªéœ€è°ƒç”¨è¿™ä¸ªå‡½æ•°,é‚£è®©æˆ‘ä»¬çœ‹çœ‹è¿™ä¸ªå‡½æ•°å‘ç”Ÿäº†ä»€ä¹ˆ:</p>

<pre><code class="language-python">def logout_user():
    user = _get_user() # ä»_request_ctx_stack.top.user,session æˆ–è€… remember_me cookie ä¸­è·å–

    if 'user_id' in session:
        session.pop('user_id')

    if '_fresh' in session:
        session.pop('_fresh')

    cookie_name = current_app.config.get('REMEMBER_COOKIE_NAME', COOKIE_NAME)
    if cookie_name in request.cookies:
        session['remember'] = 'clear'

    user_logged_out.send(current_app._get_current_object(), user=user)

    current_app.login_manager.reload_user() 
    return True
</code></pre>

<p>è¯¥å‡½æ•°å°†sessionä¸­çš„userç›¸å…³ä¿¡æ¯å…¨éƒ¨æ¸…ç©º,ç„¶åé‡æ–°åŠ è½½ç”¨æˆ·,æ­£å¸¸é€»è¾‘ä¸‹ç”±äºé‡æ–°åŠ è½½ç”¨æˆ·åå¦‚æœå½“å‰é¡µé¢éœ€è¦ç™»å½•æ‰èƒ½è®¿é—®çš„è¯,åˆ™ä¼šè·³è½¬åˆ°ç™»å½•è§†å›¾.</p>

<h1>fresh_login_required</h1>

<p>å½“ç”¨æˆ·ç™»å…¥ï¼Œä»–ä»¬çš„ä¼šè¯è¢«æ ‡è®°æˆâ€œæ–°é²œçš„â€ï¼Œå°±æ˜¯è¯´åœ¨è¿™ä¸ªä¼šè¯åªä¸­ç”¨æˆ·å®é™…ä¸Šç™»å½•è¿‡ã€‚å½“ä¼šè¯é”€æ¯ç”¨æˆ·ä½¿ç”¨â€œè®°ä½æˆ‘â€çš„ cookie é‡æ–°ç™»å…¥ï¼Œä¼šè¯è¢«æ ‡è®°æˆâ€œéæ–°é²œçš„â€ã€‚fresh_login_required é™¤äº†éªŒè¯ç”¨æˆ·ç™»å½•ï¼Œä¹Ÿå°†ç¡®ä¿ä»–ä»¬çš„ç™»å½•æ˜¯â€œæ–°é²œçš„â€ã€‚å¦‚æœä¸æ˜¯â€œæ–°é²œçš„â€ï¼Œå®ƒä¼šæŠŠç”¨æˆ·é€åˆ°å¯ä»¥é‡è¾“å…¥éªŒè¯æ¡ä»¶çš„é¡µé¢,ä¸»è¦ç”¨æˆ·ä¿®æ”¹ä¸ªäººä¿¡æ¯çš„æ•æ„Ÿæ“ä½œ.</p>

<pre><code class="language-python">def fresh_login_required(func):
    @wraps(func)
    def decorated_view(*args, **kwargs):
        if request.method in EXEMPT_METHODS:
            return func(*args, **kwargs)
        elif current_app.login_manager._login_disabled:
            return func(*args, **kwargs)
        elif not current_user.is_authenticated:
            return current_app.login_manager.unauthorized()
        elif not login_fresh(): // è·å–session ä¸­çš„ refresh å€¼
            return current_app.login_manager.needs_refresh() // 1.å‡ºç° LoginMange.needs_refress_message 2.è·³è½¬åˆ° LoginManger.refresh_view,å¦‚æœæ²¡æœ‰è®¾ç½®åˆ™ä¼šæç¤º 401 é”™è¯¯
        return func(*args, **kwargs)
    return decorated_view
</code></pre>

<h1>confirm_login</h1>

<p>å°†ä¼šè¯é‡æ–°æ ‡è®°ä¸º&rdquo;æ–°é²œ&rdquo;</p>

<pre><code class="language-python">def confirm_login():
    session['_fresh'] = True
    session['_id'] = current_app.login_manager._session_identifier_generator() // é‡æ–°ç”Ÿæˆä¼šè¯id
    user_login_confirmed.send(current_app._get_current_object())
</code></pre>

<h1>reload_user()</h1>

<p>æ¥ç€ <code>logout_user()</code> ä¸­è°ƒç”¨ <code>reload_user()</code>.å¾ˆæ˜¾ç„¶è¿™ä¸ªå‡½æ•°çš„åŠŸèƒ½å°±æ˜¯é‡æ–°åŠ è½½ç”¨æˆ·,å…·ä½“å®ç°è®©æˆ‘ä»¬çœ‹ä¸‹æºç </p>

<pre><code class="language-python"># logout_user() ä¸­è°ƒç”¨, user ä½¿ç”¨é»˜è®¤å‚æ•°ä¸º None
    def reload_user(self, user=None):
        ctx = _request_ctx_stack.top // _request_ctx_stack ä¸€ä¸ªä¿å­˜å¯¹è±¡çš„æ ˆ,å¯ä»¥è¿”å›çœ‹ login_user() æºç çš„å€’æ•°ç¬¬ä¸‰è¡Œ,ç™»å½•çš„æ—¶å€™å°† user ä¿å­˜åœ¨ _request_ctx_stack.top.user ä¸­

        if user is None: 
            user_id = session.get('user_id') // logout_user() ä¸­ session å·²ç»å°† user_id ç§»é™¤
            if user_id is None:
                ctx.user = self.anonymous_user() //è§ä¸‹æ–‡
            else:
                if self.user_callback is None: //è¿™é‡Œè§£é‡Šäº†ä¸ºä»€ä¹ˆæˆ‘ä»¬éœ€è¦å®šä¹‰ @login_manager.user_loader
                    raise Exception(
                        &quot;No user_loader has been installed for this &quot;
                        &quot;LoginManager. Add one with the &quot;
                        &quot;'LoginManager.user_loader' decorator.&quot;)
                user = self.user_callback(user_id) // è¿™é‡Œæˆ‘ä»¬æœ€åˆå®šä¹‰çš„user_loaderå‘æŒ¥ä½œç”¨,é€šè¿‡è°ƒç”¨self.user_callback()è·å–ç”¨æˆ·
                if user is None:
                    ctx.user = self.anonymous_user()
                else:
                    ctx.user = user
        else:
            ctx.user = user
</code></pre>

<h1>anoymous_user</h1>

<p>æºç å¦‚ä¸‹:</p>

<pre><code class="language-python">self.anonymous_user = AnonymousUserMixin // åŒ¿åç±»

# AnonymousUserMixin
class AnonymousUserMixin(object):
    @property
    def is_authenticated(self):
        return False

    @property
    def is_active(self):
        return False

    @property
    def is_anonymous(self):
        return True

    def get_id(self):
        return
</code></pre>

            </div>
            
            <div class="tags">
                
            </div>
            
            <div class="giscus">
                <script src="https://giscus.app/client.js"
                    data-repo="leetaogoooo/discussion-blog"
                    data-repo-id="R_kgDOIOm9Yg"
                    data-mapping="number"
                    data-term="47"
                    data-reactions-enabled="1"
                    data-emit-metadata="0"
                    data-input-position="top"
                    data-theme="preferred_color_scheme"
                    data-lang="zh-CN"
                    data-loading="lazy"
                    crossorigin="anonymous"
                    async>
                </script>
            </div>
            
            <div class="back-link">
                <a href="/">&larr; Back to posts</a>
            </div>
        </article>
    </main>
    
    <footer>
        <p>&copy; Leetao. All rights reserved.</p>
    </footer>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js"></script>
    <script src="/js/theme-toggle.js"></script>
    <script>
        
        document.addEventListener('DOMContentLoaded', function() {
            
            const pres = document.querySelectorAll('pre');
            pres.forEach(pre => {
                
                const button = document.createElement('button');
                button.className = 'copy-button';
                button.textContent = 'Copy';
                
                
                pre.appendChild(button);
                
                
                button.addEventListener('click', () => {
                    
                    const code = pre.querySelector('code');
                    const text = code ? code.textContent : pre.textContent;
                    
                    
                    navigator.clipboard.writeText(text).then(() => {
                        
                        button.textContent = 'Copied!';
                        button.classList.add('copied');
                        
                        
                        setTimeout(() => {
                            button.textContent = 'Copy';
                            button.classList.remove('copied');
                        }, 3000);
                    }).catch(err => {
                        console.error('Failed to copy: ', err);
                    });
                });
            });
        });
    </script>
</body>
</html>